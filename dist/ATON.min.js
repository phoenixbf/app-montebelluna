/*! For license information please see ATON.min.js.LICENSE.txt */
(()=>{"use strict";class e extends THREE.Group{constructor(e,t){super(),this.type=t||ATON.NTYPES.SCENE,this.enablePicking(),this.type===ATON.NTYPES.SCENE&&(this._rootG=ATON._rootVisible,this._nodes=ATON.snodes),this.type===ATON.NTYPES.SEM&&(this._rootG=ATON._rootSem,this._nodes=ATON.semnodes),this.type===ATON.NTYPES.UI&&(this._rootG=ATON._rootUI,this._nodes=ATON.uinodes),this.as(e),this.kwords=void 0,this._bCloneOnLoadHit=!0,this._tlist=void 0,this._aniMixers=void 0,this.castShadow=!1,this.receiveShadow=!1,this.onHover=void 0,this.onLeave=void 0,this.onSelect=void 0}as(e){if(void 0!==e&&e!==ATON.ROOT_NID)return this._nodes[e]=this,this.nid=e,this.name=e,this}setAsRoot(){return this._nodes[ATON.ROOT_NID]=this,this.nid=ATON.ROOT_NID,this}setCloneOnLoadHit(e){return this._bCloneOnLoadHit=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}for(let t in this.children){let o=this.children[t];void 0!==o.type&&o.addKeywords(e)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setDescription(e){return this.userData.description=e,this}getDescription(){return this.userData.description}setAudio(e){return this.userData.audio=e,this}getAudio(){return this.userData.audio}hide(){return this.visible=!1,ATON.Utils.setPicking(this,this.type,!1),ATON._renderer.shadowMap.enabled&&(ATON._dMainL.shadow.needsUpdate=!0),this}show(){return this.visible=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),ATON._renderer.shadowMap.enabled&&void 0!==ATON._dMainL&&void 0!==ATON._dMainL.shadow&&(ATON._dMainL.shadow.needsUpdate=!0),this}toggle(e){return void 0===e?this.visible?this.hide():this.show():e?this.show():this.hide()}disablePicking(){return this.bPickable=!1,ATON.Utils.setPicking(this,this.type,this.bPickable),this}enablePicking(){return this.bPickable=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),this}setPickable(e){return e?this.enablePicking():this.disablePicking(),this}setMaterial(e){this.userData.cMat=e,this.traverse((t=>{t.isMesh&&(t.material=e),t.type&&(this.userData.cMat=e)}));for(let t in this.children){let o=this.children[t];o.setMaterial&&o.setMaterial(e)}return this}getMaterial(){return this.userData.cMat}setDefaultAndHighlightMaterials(e,t){return this.userData.matSTD=e,this.userData.matHL=t,this}highlight(){return this.userData.matHL&&this.setMaterial(this.userData.matHL),this}restoreDefaultMaterial(){return this.userData.matSTD&&this.setMaterial(this.userData.matSTD),this}setOpacity(e){return this.traverse((t=>{t.isMesh&&(t.material.opacity=e)})),this}setShadowCast(e){return this.castShadow=e,this.traverse((t=>{t.isMesh&&(t.castShadow=e)})),this}setShadowReceive(e){return this.receiveShadow=e,this.traverse((t=>{t.isMesh&&(t.receiveShadow=e)})),this}setEnvMap(e){return this.traverse((t=>{t.isMesh&&(t.material.envMap=e)})),this}assignLightProbe(e){return this.traverse((t=>{t.isMesh&&t.geometry&&ATON.Utils.assignLightProbeToMesh(e,t)})),this}assignLightProbesByProximity(){return 0===ATON._lps.length||this.traverse((e=>{if(e.isMesh&&e.geometry){let t,o,i=new THREE.Vector3;(new THREE.Box3).setFromObject(e).getCenter(i);for(let e in ATON._lps){let r=ATON._lps[e],s=i.distanceToSquared(r.pos);(void 0===t||s<o)&&(o=s,t=r)}t&&ATON.Utils.assignLightProbeToMesh(t,e)}})),this}updateLightProbes=()=>(this.traverse((e=>{if(e.isMesh&&e.geometry){let t=e.userData.LP;void 0!==t&&(t.update(),e.material.envMap=t.getEnvTex())}})),this);duplicate(){let e=this.clone();return e.traverse((e=>{e.isMesh&&(e.material=e.material.clone())})),e}delete(){let e=this.parent;void 0!==e&&void 0!==e.nid&&e.removeChild(this)}removeChild(e){if(void 0!==e)return e.nid,void 0!==e.nid&&(this._nodes[e.nid]=void 0),e.parent=void 0,e.traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})),this.remove(e),this}removeChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}attachTo(e){let t="string"==typeof e?this._nodes[e]:e;return t&&(t.add(this),void 0!==t.userData.cMat&&(this.userData.cMat=t.userData.cMat),void 0!==t.bPickable&&(this.bPickable=t.bPickable)),t}attachToRoot(){return this._rootG.add(this),void 0!==this._rootG.userData.cMat&&(this.userData.cMat=this._rootG.userData.cMat),void 0!==this._rootG.bPickable&&(this.bPickable=this._rootG.bPickable),this._rootG}getBound(){let e=(new THREE.Box3).setFromObject(this),t=new THREE.Sphere;return e.getBoundingSphere(t),t}setPosition(e,t,o){return e instanceof THREE.Vector3?this.position.copy(e):this.position.set(e,t,o),this}setScale(e,t,o){return e instanceof THREE.Vector3?this.scale.copy(e):(void 0===t&&(t=e,o=e),this.scale.set(e,t,o)),this}setRotation(e,t,o){return e instanceof THREE.Vector3?this.rotation.copy(e):this.rotation.set(e,t,o),this}orientToCamera(){return this.quaternion.copy(ATON.Nav._qOri),this}setYup(){return this.rotation.set(-1.57079632679,0,0),this}addTransform(e){let t;return"string"==typeof e&&(t=ATON.Utils.parseTransformString(e)),void 0===t||(void 0===this._tlist&&(this._tlist=[]),this._tlist.push(t)),this}load(e,t){if(void 0===e)return this;e=ATON.Utils.resolveCollectionURL(e);let o=this;if(e.endsWith("tileset.json"))return ATON.Utils.loadTileSet(e,o),ATON._bqScene=!0,t&&t(),o;if(o._bCloneOnLoadHit&&void 0!==ATON._assetsManager[e])return ATON._assetsManager[e].then((e=>{let i=e.clone();if(ATON.Utils.modelVisitor(o,i),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(i.clone()),o.add(o._tlist[e]);else o.add(i);t&&t()})),console.log("HIT!"),o;ATON._assetReqNew(e);let i=new Promise(((i,r)=>{ATON._aLoader.load(e,(r=>{let s=r.scene||r.scene[0];if(ATON.Utils.modelVisitor(o,s),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(s.clone()),o.add(o._tlist[e]);else o.add(s);ATON.Utils.registerAniMixers(o,r),ATON.Utils.ccExtract(r),i(s),console.log("Model loaded"),ATON._assetReqComplete(e),o.type===ATON.NTYPES.SCENE&&(ATON._bqScene=!0),o.type===ATON.NTYPES.SEM&&(ATON._bqSem=!0),o.bPickable&&o.enablePicking(),t&&t()}),void 0,(o=>{console.log("Error loading model"),ATON._assetReqComplete(e),t&&t()}))}));return o._bCloneOnLoadHit&&(ATON._assetsManager[e]=i),this}exportAs(e){return ATON.Utils.exportNode(this,e),this}setOnHover(e){return this.onHover=e,this}setOnLeave(e){return this.onLeave=e,this}setOnSelect(e){return this.onSelect=e,this}}const t=e;let o={init:()=>{o.evLocal={},o.evNetwork={},ATON.on=o.on,ATON.fireEvent=o.fireEvent,ATON.clearEventHandlers=o.clearEventHandlers},clearEventHandlers:e=>{o.evLocal[e]=[],o.evNetwork[e]=[]},executeHandlers:(e,t)=>{if(e)for(let o=0;o<e.length;o++){const i=e[o];i&&i(t)}},on:(e,t,i)=>{if(void 0!==t){const i=o.evLocal;void 0===i[e]&&(i[e]=[]),i[e].push(t)}void 0!==i&&ATON.VRoadcast.on(e,i)},fireEvent:(e,t,i)=>{const r=o.evLocal[e];o.executeHandlers(r,t),i&&ATON.VRoadcast.fireEvent(e,t)}};const i=o;let r={init:()=>{r.materials={},r.colors={},r._loader=new THREE.MaterialLoader,r._uSem={time:{type:"float",value:0},tint:{type:"vec4",value:new THREE.Vector4(.2,.2,1,.2)}},r.addDefaults()},getDefVertexShader:()=>"\n        varying vec3 vPositionW;\n        varying vec3 vNormalW;\n        varying vec3 vNormalV;\n\n        void main(){\n            vPositionW = vec3( vec4( position, 1.0 ) * modelMatrix);\n            vNormalW   = normalize( vec3( vec4( normal, 0.0 ) * modelMatrix ) );\n            vNormalV   = normalize( vec3( normalMatrix * normal ));\n\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",addDefaults:()=>{r.colors.white=new THREE.Color(1,1,1),r.colors.black=new THREE.Color(0,0,0),r.colors.green=new THREE.Color(0,1,0),r.colors.yellow=new THREE.Color(1,1,0),r.colors.red=new THREE.Color(1,0,0),r.colors.blue=new THREE.Color(0,0,1),r.colors.orange=new THREE.Color(1,.5,0),r.colors.defUI=new THREE.Color(0,1,.5),r.colors.sem=new THREE.Color(0,1,.5),r.colors.darksem=new THREE.Color(0,0,.1),r.materials.fullyTransparent=new THREE.MeshBasicMaterial({transparent:!0,depthWrite:!1,opacity:0}),r.materials.defUI=new THREE.ShaderMaterial({uniforms:{color:{type:"vec3",value:r.colors.defUI},opacity:{type:"float",value:.8}},vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            uniform vec3 color;\n            uniform float opacity;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(viewDirectionW, vNormalW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0 - f, 0.2, 1.0);\n\n\t\t        gl_FragColor = vec4(color.rgb, f * opacity);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.selector=r.materials.defUI.clone(),r.materials.controllerRay=r.materials.defUI.clone(),r.materials.controllerRay.uniforms.color.value=r.colors.white,r.materials.teleportLoc=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,depthWrite:!1,side:THREE.DoubleSide}),ATON.Utils.textureLoader.load(ATON.PATH_RES+"grad.png",(e=>{r.materials.teleportLoc.map=e})),r.materials.measurement=new THREE.MeshBasicMaterial({color:r.colors.white,transparent:!0,depthWrite:!1,opacity:.5,depthTest:!1}),r.materials.semanticShape=new THREE.ShaderMaterial({uniforms:r._uSem,vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n            uniform float time;\n            uniform vec4 tint;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                //float ff = dot(vNormalV, vec3(0,0,1));\n\t\t        //ff = clamp(1.0-ff, 0.0, 1.0);\n\n                float f = (1.0 * cos(time*2.0)); // - 0.5;\n                //f = cos(time + (vPositionW.y*10.0));\n                f = clamp(f, 0.0,1.0);\n\n\t\t        gl_FragColor = vec4(tint.rgb, tint.a * f);\n                //gl_FragColor = vec4(tint.rgb, ff);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.semanticShapeHL=new THREE.MeshBasicMaterial({color:r.colors.sem,transparent:!0,depthWrite:!1,opacity:.2}),r.materials.semanticShapeEdit=new THREE.MeshBasicMaterial({color:r.colors.orange,transparent:!0,depthWrite:!1,opacity:.5}),r.semIcon=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-sem.png"),transparent:!0,opacity:1,depthTest:!1}),r.materials.lp=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n\t\t    void main(){\n\t\t        vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(viewDirectionW, vNormalW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0 - f, 0.0, 1.0);\n\n\t\t        gl_FragColor = vec4(1.0,1.0,1.0, f);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.lpIcon=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-lp.png"),transparent:!0,opacity:1,depthWrite:!1}),r.semIcon.sizeAttenuation=!1,r.lpIcon.sizeAttenuation=!1},addMaterial:(e,t)=>{r.materials[e]?console.log("MatHub: material "+e+" already registered"):r.materials[e]=t},loadMaterial:(e,t)=>{r._loader.load(t,(t=>{r.addMaterial(e,t)}),void 0,(e=>{console.log(e)}))},getMaterial:e=>r.materials[e],update:()=>{r._uSem.time.value+=ATON._dt}};const s=r;let n={TSTRING_SEPARATOR:" ",init:()=>{ATON.device={},n.geomUnitSphere=new THREE.SphereGeometry(1,16,16),n.exporterGLTF=void 0,n.exporterOBJ=void 0,n._dlink=document.createElement("a"),n._dlink.style.display="none",document.body.appendChild(n._dlink),n.textureLoader=new THREE.TextureLoader},generateID:e=>(void 0===e&&(e="id"),e+"-"+Math.random().toString(36).substr(2,9)),goToURL:e=>{window.location.href=e},isConnectionSecure:()=>window.isSecureContext,profileDevice:()=>{ATON.device.isMobile=!1,ATON.device.isMobile=!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))),ATON.device.xrSupported={},ATON.device.xrSupported["immersive-vr"]=!1,ATON.device.xrSupported["immersive-ar"]=!1,"xr"in navigator&&(navigator.xr.isSessionSupported("immersive-vr").then((e=>{ATON.device.xrSupported["immersive-vr"]=!!e,console.log("WebXR VR session support: "+ATON.device.xrSupported["immersive-vr"]),ATON.fireEvent("XR_support",{type:"immersive-vr",v:ATON.device.xrSupported["immersive-vr"]})})),navigator.xr.isSessionSupported("immersive-ar").then((e=>{ATON.device.xrSupported["immersive-ar"]=!!e,console.log("WebXR AR session support: "+ATON.device.xrSupported["immersive-ar"]),ATON.fireEvent("XR_support",{type:"immersive-ar",v:ATON.device.xrSupported["immersive-ar"]})})))},profileRenderingCapabilities:()=>{if(void 0===ATON._renderer)return;let e=ATON._renderer.capabilities;void 0!==e&&(ATON.device.lowGPU=!1,e.isWebGL2||(ATON.device.lowGPU=!0),e.maxTextureSize<8192&&(ATON.device.lowGPU=!0),console.log(e))},isMobile:()=>ATON.device.isMobile,isVRsupported:()=>ATON.device.xrSupported["immersive-vr"],isARsupported:()=>ATON.device.xrSupported["immersive-ar"],getFileExtension:e=>e.substr(e.lastIndexOf(".")+1).toLowerCase(),removeFileExtension:e=>e.replace(/\.[^/.]+$/,""),isVideo:e=>{let t=n.getFileExtension(e);return"mp4"===t||"webm"===t||void 0},getBaseFolder:e=>{var t=e.lastIndexOf("/");return-1!==t?e.substring(0,t+1):""},isResourceURL:e=>!!e.startsWith("http://")||!!e.startsWith("https://"),URLify:e=>{const t=e.match(/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)/g);return t&&t.forEach((function(t){e=e.replace(t,'<a target="_blank" href="'+t+'">'+t+"</a>")})),e},resolveCollectionURL:e=>e.startsWith("http")?e:ATON.PATH_COLLECTION+e,postJSON:(e,t,o,i)=>{$.ajax({url:e,type:"POST",xhrFields:{withCredentials:!0},data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{o&&o(e)}}).fail((e=>{console.log(e),i&&i()}))},mergeObject:e=>{e.updateMatrixWorld(!0);const t=[];e.traverse((e=>{if(e.isMesh){const o=e.geometry;o.applyMatrix4(e.matrixWorld),t.push(o.toNonIndexed())}}));const o=THREE.BufferGeometryUtils.mergeBufferGeometries(t,!1),i=THREE.BufferGeometryUtils.mergeVertices(o).center(),r=new THREE.Group,s=new THREE.Mesh(i);return r.add(s),r},setPicking:(e,t,o)=>{void 0===o&&(o=!0),e.traverse((e=>{o?e.layers.enable(t):e.layers.disable(t)}))},graphPostVisitor:e=>{e.visible?console.log(e):n.setPicking(e,e.type,!1)},updateTSetsCamera:e=>{void 0===e&&(e=ATON.Nav._camera);const t=ATON._tsets.length;if(!(t<=0))for(let o=0;o<t;o++){const t=ATON._tsets[o];for(let e in t.cameras)t.deleteCamera(t.cameras[e]);t.setCamera(e),t.setResolution(e,200,200)}},loadTileSet:(e,t)=>{let o=new TILES.TilesRenderer(e);if(!o)return;o.fetchOptions.mode="cors",o.setCamera(ATON.Nav._camera),o.setResolutionFromRenderer(ATON.Nav._camera,ATON._renderer);let i=!1;o.onLoadModel=e=>{i||(ATON._onAllReqsCompleted(),i=!0),e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0),e.material&&(t.userData.cMat&&(e.material=t.userData.cMat),e.material.map&&(e.material.map.minFilter=THREE.LinearMipmapLinearFilter,e.material.map.magFilter=THREE.LinearFilter))}))},o.onDisposeModel=e=>{e.traverse((e=>{e.isMesh&&e.material.dispose()}))},t.add(o.group),n.setPicking(t,t.type,!0),ATON._tsets.push(o)},modelVisitor:(e,t)=>{if(void 0===t)return;if(void 0===e)return;let o=e.type;t.traverse((t=>{t.isMesh&&(o===ATON.NTYPES.SCENE&&(t.castShadow=!0,t.receiveShadow=!0,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed visible BVH")),null!==t.material.map&&(t.material.map.generateMipmaps=!0,t.material.map.anisotropy=ATON.device.isMobile?0:ATON._maxAnisotropy,t.material.map.minFilter=THREE.LinearMipmapLinearFilter,t.material.map.magFilter=THREE.LinearFilter)),o===ATON.NTYPES.SEM&&(t.material=ATON.MatHub.materials.semanticShape,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed semantic BVH"))),e.userData.cMat&&(t.material=e.userData.cMat))}))},registerAniMixers:(e,t)=>{let o=t.scene||t.scene[0],i=!1;if(void 0===t.animations)return;let r=new THREE.AnimationMixer(o);t.animations.forEach((e=>{r.clipAction(e).play(),i=!0})),i&&(ATON._aniMixers.push(r),void 0===e._aniMixers&&(e._aniMixers=[]),e._aniMixers.push(r))},ccExtract:e=>{if(void 0===e)return;if(void 0===e.asset)return;let t={};if(e.asset.copyright&&(t.copyright=e.asset.copyright),e.asset.extras)for(let o in e.asset.extras)t[o]=e.asset.extras[o];e.asset.generator&&(t.generator=e.asset.generator),(e.asset.copyright||e.asset.extras)&&ATON._ccModels.push(t),console.log(t)},parseTransformString:e=>{let t=new THREE.Group,o=e.split(n.TSTRING_SEPARATOR),i=o.length;return i<3||(t.position.set(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),i<6||(t.rotation.set(parseFloat(o[3]),parseFloat(o[4]),parseFloat(o[5])),i<9||t.scale.set(parseFloat(o[6]),parseFloat(o[7]),parseFloat(o[8])))),t},setVectorPrecision:(e,t)=>(e.x=parseFloat(e.x.toPrecision(t)),e.y=parseFloat(e.y.toPrecision(t)),e.z=parseFloat(e.z.toPrecision(t)),e),parseMD:e=>(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/^\s*\n\*/gm,"<ul>\n*")).replace(/^(\*.+)\s*\n([^\*])/gm,"$1\n</ul>\n\n$2")).replace(/^\*(.+)/gm,"<li>$1</li>")).replace(/^\s*\n\d\./gm,"<ol>\n1.")).replace(/^(\d\..+)\s*\n([^\d\.])/gm,"$1\n</ol>\n\n$2")).replace(/^\d\.(.+)/gm,"<li>$1</li>")).replace(/^\>(.+)/gm,"<blockquote>$1</blockquote>")).replace(/[\#]{6}(.+)/g,"<h6>$1</h6>")).replace(/[\#]{5}(.+)/g,"<h5>$1</h5>")).replace(/[\#]{4}(.+)/g,"<h4>$1</h4>")).replace(/[\#]{3}(.+)/g,"<h3>$1</h3>")).replace(/[\#]{2}(.+)/g,"<h2>$1</h2>")).replace(/[\#]{1}(.+)/g,"<h1>$1</h1>")).replace(/^(.+)\n\=+/gm,"<h1>$1</h1>")).replace(/^(.+)\n\-+/gm,"<h2>$1</h2>")).replace(/\!\[([^\]]+)\]\(([^\)]+)\)/g,'<img src="$2" alt="$1" />')).replace(/[\[]{1}([^\]]+)[\]]{1}[\(]{1}([^\)\"]+)(\"(.+)\")?[\)]{1}/g,'<a href="$2" title="$4">$1</a>')).replace(/[\*\_]{2}([^\*\_]+)[\*\_]{2}/g,"<b>$1</b>")).replace(/[\*\_]{1}([^\*\_]+)[\*\_]{1}/g,"<i>$1</i>")).replace(/[\~]{2}([^\~]+)[\~]{2}/g,"<del>$1</del>")).replace(/^\s*\n\`\`\`(([^\s]+))?/gm,'<pre class="$2">')).replace(/^\`\`\`\s*\n/gm,"</pre>\n\n")).replace(/[\`]{1}([^\`]+)[\`]{1}/g,"<code>$1</code>")).replace(/^\s*(\n)?(.+)/gm,(function(e){return/\<(\/)?(h\d|ul|ol|li|blockquote|pre|img)/.test(e)?e:"<p>"+e+"</p>"}))).replace(/(\<pre.+\>)\s*\n\<p\>(.+)\<\/p\>/gm,"$1$2"),checkAuth:e=>{$.ajax({type:"GET",url:ATON.PATH_RESTAPI+"user",xhrFields:{withCredentials:!0},dataType:"json",success:t=>{e(t)}})},getHumanReadableDistance:e=>{let t=" m";return e<.01?(t=" mm",t=(e*=1e3).toPrecision(3)+t,t):e<1?(t=" cm",t=(e*=100).toPrecision(3)+t,t):e>1e3?(t=" km",t=e.toPrecision(3)+t,t):(t=e.toPrecision(3)+t,t)},stripHTMLtagsFromString:e=>e.replace(/(<([^>]+)>)/gi,""),requestFullscreen:()=>{let e=document.documentElement;return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),!0},downloadBlob:(e,t)=>{void 0!==t&&(n._dlink.href=URL.createObjectURL(e),n._dlink.download=t,n._dlink.click())},downloadText:(e,t)=>{n.downloadBlob(new Blob([e],{type:"text/plain"}),t)},downloadJSONobj:(e,t)=>{n.downloadText(JSON.stringify(e),t)},downloadArrayBuffer:(e,t)=>{n.downloadBlob(new Blob([e],{type:"application/octet-stream"}),t)},exportNode:(e,t)=>{let o=n.getFileExtension(t);if(!(o.length<1)){if("glb"===o||"gltf"===o){let i={binary:"glb"===o};void 0===n.exporterGLTF&&(n.exporterGLTF=new THREE.GLTFExporter),n.exporterGLTF.parse(e,(e=>{e instanceof ArrayBuffer?n.downloadArrayBuffer(e,t):(console.log(e),n.downloadJSONobj(e,t))}),i)}if("obj"===o){void 0===n.exporterOBJ&&(n.exporterOBJ=new THREE.OBJExporter);let o=n.exporterOBJ.parse(e);n.downloadText(o,t)}}},takeScreenshot:(e,t)=>{let o=new Image;console.log("Screenshot with size:"+e),ATON.Nav._camera.aspect=1,ATON.Nav._camera.updateProjectionMatrix(),ATON._renderer.setSize(e,e),ATON._renderer.render(ATON._mainRoot,ATON.Nav._camera);let i=ATON._renderer.domElement;if(ATON.FX.composer){ATON.FX.composer.setSize(e,e);let t=ATON.FX.passes[ATON.FX.PASS_AA].material.uniforms;t&&t.resolution.value.set(1/e,1/e),ATON.FX.composer.render(),i=ATON.FX.composer.renderer.domElement}let r=ATON._renderer.domElement.toDataURL();return o.src=r,t&&(n._dlink.href=r.replace("image/png","image/octet-stream"),n._dlink.download=t,n._dlink.click()),ATON._onResize(),o},assignLightProbeToMesh:(e,t)=>{void 0!==e&&void 0!==t&&(t.noLP||(t.userData.LP=e))},createATONCube:e=>{let t=new THREE.BoxBufferGeometry(1,1,1),o=new THREE.MeshStandardMaterial;n.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",(e=>{e.encoding=THREE.sRGBEncoding,o.map=e}));let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createATONCubePBR:e=>{let t=new THREE.BoxBufferGeometry(1,1,1),o=new THREE.MeshStandardMaterial;o.metalness=1,n.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",(e=>{e.encoding=THREE.sRGBEncoding,o.map=e})),n.textureLoader.load(ATON.PATH_RES+"models/aton-cube-pbr.jpg",(e=>{e.encoding=THREE.sRGBEncoding,o.metalnessMap=e,o.roughnessMap=e})),n.textureLoader.load(ATON.PATH_RES+"models/aton-cube-nrm.png",(e=>{e.encoding=THREE.sRGBEncoding,o.normalMap=e}));let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createGround:(e,t,o)=>{void 0===t&&(t=1),void 0===o&&(o=1);let i=new THREE.PlaneBufferGeometry(t,o),r=new THREE.MeshStandardMaterial;void 0!==e&&n.textureLoader.load(e,(e=>{e.encoding=THREE.sRGBEncoding,r.map=e}));let s=ATON.createSceneNode().rotateX(.5*-Math.PI);return s.add(new THREE.Mesh(i,r)),s.enablePicking(),s}};const a=n;let d={MODE_ADD:0,MODE_DEL:1,FLOAT_PREC:5,init:()=>{d.currID=void 0,d.currData=void 0,d._bEdit=!1,d._bLoading=!1,d._title=void 0,d._descr=void 0,d.initBaseParsers()},setEditMode:e=>{d._bEdit=e,console.log("Edit mode:"+e)},load:(e,t,o)=>(d._bLoading=!0,console.log("Loading Scene: "+t),$.getJSON(e,(e=>{d.currData=e,d.currID=t,d._bLoading=!1,d.parseScene(e),o&&o(),ATON.fireEvent("SceneJSONLoaded",t)}))),parseScene:e=>{if(void 0!==(e=void 0===e?d.currData:e))for(let t in e)d._jsonParsers[t]&&d._jsonParsers[t](e[t])},getJSONchildren:(e,t)=>{let o;void 0===t&&(t=ATON.NTYPES.SCENE);let i=[];if(t===ATON.NTYPES.SEM&&(o=ATON.getSemanticNode(e)),t===ATON.NTYPES.SCENE&&(o=ATON.getSceneNode(e)),void 0!==o){for(let e in o.children){let t=o.children[e];void 0!==t.nid&&i.push(t.nid)}return i}},getJSONgraphEdges:e=>{void 0===e&&(e=ATON.NTYPES.SCENE);let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes),e===ATON.NTYPES.UI&&(t=ATON.uinodes);let o={};for(let e in t){let i=t[e];i&&i.parent&&i.parent.nid&&(void 0===o[i.parent.nid]&&(o[i.parent.nid]=[]),o[i.parent.nid].push(i.nid))}return o},getJSONsemanticSpheresList:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.type&&o.push([parseFloat(i.position.x.toPrecision(d.FLOAT_PREC)),parseFloat(i.position.y.toPrecision(d.FLOAT_PREC)),parseFloat(i.position.z.toPrecision(d.FLOAT_PREC)),parseFloat(i.scale.x.toPrecision(d.FLOAT_PREC))])}return o},getJSONsemanticConvexShapes:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.userData._convexPoints&&o.push(i.userData._convexPoints)}return o},initBaseParsers:()=>{d._jsonParsers={},d._jsonParsers.title=e=>{void 0!==e&&d.setTitle(e)},d._jsonParsers.description=e=>{void 0!==e&&d.setDescription(e)},d._jsonParsers.fx=e=>{e.ao&&(ATON.FX.togglePass(ATON.FX.PASS_AO,!0),e.ao.i&&ATON.FX.setAOintensity(parseFloat(e.ao.i))),e.bloom&&(ATON.FX.togglePass(ATON.FX.PASS_BLOOM,!0),e.bloom.i&&ATON.FX.setBloomStrength(parseFloat(e.bloom.i)),e.bloom.t&&ATON.FX.setBloomThreshold(parseFloat(e.bloom.t))),e.dof&&(ATON.FX.togglePass(ATON.FX.PASS_DOF,!0),e.dof.f&&ATON.FX.setDOFfocus(parseFloat(e.dof.f)))},d._jsonParsers.environment=e=>{let t=e.mainpano;e.mainpano&&(t.url&&ATON.setMainPanorama(t.url),t.rotation&&ATON.setMainPanoramaRotation(t.rotation)),e.bgcolor&&ATON.setBackgroundColor(new THREE.Color(e.bgcolor[0],e.bgcolor[1],e.bgcolor[2]));let o=e.mainlight;o?(o.direction&&ATON.setMainLightDirection(new THREE.Vector3(o.direction[0],o.direction[1],o.direction[2])),ATON._dMainL?(o.color&&(ATON._dMainL.color=new THREE.Color(o.color[0],o.color[1],o.color[2])),o.intensity&&(ATON._dMainL.intensity=o.intensity),void 0!==o.shadows?ATON.toggleShadows(o.shadows):ATON.toggleShadows(!1)):ATON.toggleMainLight(!1)):ATON.toggleMainLight(!1);let i=e.lightprobes;i&&i.auto&&ATON.setAutoLP(!0),e.exposure&&ATON.setExposure(e.exposure)},d._jsonParsers.soundscape=e=>{void 0!==e&&e.global&&ATON.setGlobalAudio(e.global.url,e.global.loop)},d._jsonParsers.navmode=e=>{void 0!==e&&ATON.Nav.setNavMode(e)},d._jsonParsers.measurements=e=>{if(void 0!==e)for(let t in e){let o=e[t];if(o.points&&6===o.points.length){let e=new THREE.Vector3(parseFloat(o.points[0]),parseFloat(o.points[1]),parseFloat(o.points[2])),t=new THREE.Vector3(parseFloat(o.points[3]),parseFloat(o.points[4]),parseFloat(o.points[5]));ATON.SUI.addMeasurementPoint(e),ATON.SUI.addMeasurementPoint(t)}}},d._jsonParsers.viewpoints=e=>{if(void 0!==e)for(let t in e){let o=e[t];"home"===t?ATON.Nav.setHomePOV((new ATON.POV).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)):new ATON.POV(t).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)}},d._jsonParsers.scenegraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSceneNode(e).removeChildren(),r=o.transform;r&&(r.position&&i.setPosition(r.position[0],r.position[1],r.position[2]),r.rotation&&i.setRotation(r.rotation[0],r.rotation[1],r.rotation[2]),r.scale&&i.setScale(r.scale[0],r.scale[1],r.scale[2]),r.list&&Array.isArray(r.list));let s=o.urls;s&&(Array.isArray(s)?s.forEach((e=>{ATON.createSceneNode().load(e).attachTo(i)})):i.load(s)),o.shadowcast&&i.setShadowCast(o.shadowcast),o.shadowreceive&&i.setShadowCast(o.shadowreceive),o.toYup&&i.setYup(),o.keywords&&(i.kwords=o.keywords)}for(let e in o){let t=o[e],i=ATON.getSceneNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSceneNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSceneNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.material)){let e=new THREE.MeshStandardMaterial(o.material);i.setMaterial(e)}}},d._jsonParsers.semanticgraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSemanticNode(e).removeChildren(),r=o.urls;r&&(Array.isArray(r)?r.forEach((e=>{ATON.createSemanticNode().load(e).attachTo(i)})):i.load(r)),o.toYup&&i.setYup(),o.description&&i.setDescription(o.description),o.audio&&i.setAudio(o.audio),o.keywords&&(i.kwords=o.keywords);let s=o.spheres;if(Array.isArray(s))for(let t in s){let o=s[t],i=new THREE.Vector3(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]));ATON.SemFactory.createSphere(e,i,parseFloat(o[3]))}let n=o.convexshapes;if(Array.isArray(n))for(let t in n){let o=n[t],i=[];for(let e=0;e<o.length;e+=3){let t=new THREE.Vector3(o[e],o[e+1],o[e+2]);i.push(t)}ATON.SemFactory.createConvexShape(e,i)}}for(let e in o){let t=o[e],i=ATON.getSemanticNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSemanticNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSemanticNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.nopicking&&i.disablePicking(),o.material)){let e=new THREE.MeshStandardMaterial(o.material);i.setMaterial(e)}}}},addSceneParser:(e,t)=>{d._jsonParsers[e]=t},sendEdit:(e,t,o)=>{if(d._bLoading||!d._bEdit)return;if(void 0===e)return;void 0===t&&(t=d.MODE_ADD);let i=d.currID,r={};r.sid=i,r.data=e,r.mode=t===d.MODE_DEL?"DEL":"ADD";let s=JSON.stringify(r);e=null,r=null,$.ajax({url:ATON.PATH_RESTAPI+"edit/scene",type:"POST",data:s,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{e&&(d.currData=e),o&&o()}})},setTitle:e=>{d._title=e},getTitle:()=>d._title,setDescription:e=>{d._descr=e},getDescription:()=>d._descr};const l=d;let c={init:()=>{c._listener=new THREE.AudioListener,c._loader=new THREE.AudioLoader},playOnceGlobally:e=>{e=ATON.Utils.resolveCollectionURL(e);let t=new THREE.Audio(ATON.AudioHub._listener);c._loader.load(e,(e=>{t.setBuffer(e),t.play()}))}};const u=c;let _={STD_FOV:50,STD_NEAR:.01,STD_FAR:800,FP_EPS:.01,STD_POV_TRANS_DURATION:2,MODE_ORBIT:0,MODE_FP:1,MODE_DEVORI:2,init:()=>{_._mode=void 0,_.POVtransitionDuration=_.STD_POV_TRANS_DURATION,_._rotSpeedOrbit=.4,_._rotSpeedFP=-.2,_._inertia=.08,_._bControl=!0,_._bInteracting=!1,_._prevMode=void 0,_.setOrbitControl(),_._currPOV=(new ATON.POV).setFOV(ATON.Nav.STD_FOV),_._fromPOV=new ATON.POV,_._reqPOV=new ATON.POV,_.homePOV=void 0,_._tPOVcall=-1,_._tPOVprogress=0,_.povlist={},_._vDir=new THREE.Vector3(1,0,0),_._qOri=new THREE.Quaternion,_._motionAmt=0,_._motionDir=new THREE.Vector3(0,1,0),_._bValidLocomotion=!1},getCurrentEyeLocation:()=>_._currPOV.pos,getCurrentDirection:()=>_._vDir,copyCurrentPOV:()=>{let e=new ATON.POV;return e.pos.copy(_._currPOV.pos),e.target.copy(_._currPOV.target),e.fov=_._currPOV.fov,e},addPOV:(e,t)=>{if(void 0!==e)return e.as(t),e},isTransitioning:()=>_._tPOVcall>=0,currentQueryValidForLocomotion:()=>_._bValidLocomotion,locomotionValidator:()=>{if(void 0===ATON._queryDataScene)return void(_._bValidLocomotion=!1);ATON._queryDataScene.p;let e=ATON._queryDataScene.n;e?e.y<=.7?_._bValidLocomotion=!1:_._bValidLocomotion=!0:_._bValidLocomotion=!1},setUserControl:e=>{void 0!==e&&e!==_._bControl&&(_._bControl=e,void 0!==_._controls&&(_._controls.enabled=e),_._cOrbit&&(_._cOrbit.enabled=e),_._cFirstPerson&&(_._cFirstPerson.enabled=e),console.log("Nav controls: "+_._bControl))},toggleUserControl:()=>{_.setUserControl(!_._bControl)},isUserControlEnabled:()=>_._bControl,isOrbit:()=>_._mode===_.MODE_ORBIT,isFirstPerson:()=>_._mode===_.MODE_FP,isDevOri:()=>_._mode===_.MODE_DEVORI,setNavMode:e=>{void 0!==e&&(e===_.MODE_ORBIT&&_.setOrbitControl(),e===_.MODE_FP&&_.setFirstPersonControl(),e===_.MODE_DEVORI&&_.setDeviceOrientationControl())},restorePreviousNavMode:()=>{void 0===_._prevMode&&_.setOrbitControl(),_.setNavMode(_._prevMode)},_updCamera:e=>{if(void 0===e&&(e=_._camera),ATON.FX.composer){let t=ATON.FX.composer.passes;if(t)for(let o=0;o<t.length;o++)t[o].camera&&(t[o].camera=e)}ATON.Utils.updateTSetsCamera(e)},setOrbitControl:()=>{if(!ATON.XR.isPresenting()){if(_._prevMode=_._mode,_._mode=_.MODE_ORBIT,_._bInteracting=!1,void 0===_._cOrbit){_._camOrbit=new THREE.PerspectiveCamera(_.STD_FOV,window.innerWidth/window.innerHeight,_.STD_NEAR,_.STD_FAR),_._camOrbit.layers.enableAll(),_._cOrbit=new THREE.OrbitControls(_._camOrbit,ATON._renderer.domElement);let e=_._cOrbit;e.rotateSpeed=_._rotSpeedOrbit,e.enablePan=!0,_._inertia>0&&(e.enableDamping=!0,e.dampingFactor=_._inertia),e.screenSpacePanning=!0,e.enableZoom=!0,e.minDistance=.03,e.maxDistance=100,_._bControl||(e.enabled=!1),e.addEventListener("start",(()=>{_._bInteracting=!0})),e.addEventListener("end",(()=>{_._bInteracting=!1}))}_._controls=_._cOrbit,_._camera=_._camOrbit,ATON.AudioHub._listener&&_._camera.children.length<1&&_._camera.add(ATON.AudioHub._listener),_._updCamera(),_._controls.update(),_._currPOV&&_.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fireEvent("NavMode",_._mode)}},setFirstPersonControl:()=>{if(!ATON.XR.isPresenting()){if(_._prevMode=_._mode,ATON.SUI.getSelectorRadius()>.5&&ATON.SUI.setSelectorRadius(.5),_._mode=_.MODE_FP,_._bInteracting=!1,void 0===_._cFirstPerson){_._camFP=new THREE.PerspectiveCamera(_.STD_FOV,window.innerWidth/window.innerHeight,_.STD_NEAR,_.STD_FAR),_._camFP.layers.enableAll(),_._cFirstPerson=new THREE.OrbitControls(_._camFP,ATON._renderer.domElement);let e=_._cFirstPerson;e.enableZoom=!1,e.enablePan=!1,e.rotateSpeed=_._rotSpeedFP,_._inertia>0&&(e.enableDamping=!0,e.dampingFactor=_._inertia),e.target.copy(_._camera.position),e.minDistance=.01,e.maxDistance=.01,_._bControl||(e.enabled=!1)}_._controls=_._cFirstPerson,_._camera=_._camFP,ATON.AudioHub._listener&&_._camera.children.length<1&&_._camera.add(ATON.AudioHub._listener),_._updCamera(),_._controls.update(),_._currPOV&&_.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fireEvent("NavMode",_._mode)}},setDeviceOrientationControl:()=>{ATON.Utils.isMobile()&&(_._prevMode=_._mode,_._mode=_.MODE_DEVORI,_._bInteracting=!1,ATON._screenPointerCoords.set(0,0),void 0===_._cDevOri&&(_._camDevOri=new THREE.PerspectiveCamera(_.STD_FOV,window.innerWidth/window.innerHeight,_.STD_NEAR,_.STD_FAR),_._camDevOri.layers.enableAll(),_._cDevOri=new THREE.DeviceOrientationControls(_._camDevOri,ATON._renderer.domElement),_._cDevOri.alphaOffset=0),_._controls=_._cDevOri,_._camera=_._camDevOri,ATON.AudioHub._listener&&_._camera.children.length<1&&_._camera.add(ATON.AudioHub._listener),_._updCamera(),_._controls.update(),_._currPOV&&_.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!0),ATON.fireEvent("NavMode",_._mode))},setMotionAmount:e=>{_._motionAmt=e},setMotionDirection:e=>{_._motionDir.copy(e)},stop:()=>{_._motionAmt=0},setFOV:e=>{if(ATON.XR.isPresenting())return;_._currPOV.fov=e;let t=_._camera;t.fov=e,t.updateProjectionMatrix()},getFOV:()=>_._currPOV.fov,syncCurrPOV:()=>{if(ATON.XR.isPresenting())return ATON.XR._cam=ATON._renderer.xr.getCamera(_._camera),ATON.XR._cam.getWorldPosition(_._currPOV.pos),ATON.XR._cam.getWorldQuaternion(_._qOri),void ATON.XR._cam.getWorldDirection(_._vDir);const e=_._controls,t=_._camera;if(t.getWorldDirection(_._vDir),t.getWorldQuaternion(_._qOri),_._mode!==_.MODE_DEVORI){if(_._mode===_.MODE_FP)return _._currPOV.pos.copy(e.target),_._currPOV.target.x=_._currPOV.pos.x+_._vDir.x,_._currPOV.target.y=_._currPOV.pos.y+_._vDir.y,void(_._currPOV.target.z=_._currPOV.pos.z+_._vDir.z);_._currPOV.pos.copy(t.position),_._currPOV.target.copy(e.target)}else _._currPOV.pos.copy(t.position)},handlePOV:()=>{ATON.XR.isPresenting()?_.handleXRtransition():_.handlePOVtransition()},handleMotion:()=>{if(!_.isTransitioning()&&0!=_._motionAmt){ATON.XR.controller0&&ATON.XR.controller0.visible?(ATON.XR.controller0.getWorldDirection(_._motionDir),_._motionDir.negate()):_._motionDir.copy(_._vDir);let e=_._motionDir.clone();e.multiplyScalar(_._motionAmt*ATON._dt),_._currPOV.pos.add(e),_._currPOV.target.add(e)}},handlePOVtransition:()=>{if(!(_._tPOVcall<0)){if(_.POVtransitionDuration<=0?_._tPOVprogress=1:_._tPOVprogress=(ATON._clock.elapsedTime-_._tPOVcall)/_.POVtransitionDuration,_._tPOVprogress>=1)return _._tPOVcall=-1,_._currPOV.pos.copy(_._reqPOV.pos),_._currPOV.target.copy(_._reqPOV.target),_._currPOV.fov=_._reqPOV.fov,void ATON.fireEvent("POVTransitionCompleted",_._reqPOV.id);var e;_._tPOVprogress=(e=_._tPOVprogress,(1-Math.cos(e*Math.PI))/2),_._currPOV.pos.lerpVectors(_._fromPOV.pos,_._reqPOV.pos,_._tPOVprogress),_._currPOV.target.lerpVectors(_._fromPOV.target,_._reqPOV.target,_._tPOVprogress),_._fromPOV.fov&&_._reqPOV.fov&&(_._currPOV.fov=THREE.MathUtils.lerp(_._fromPOV.fov,_._reqPOV.fov,_._tPOVprogress),_._camera.fov=_._currPOV.fov,_._camera.updateProjectionMatrix())}},handleXRtransition:()=>{if(!(_._tPOVcall<0)){if(_.POVtransitionDuration<=0?_._tPOVprogress=1:_._tPOVprogress=(ATON._clock.elapsedTime-_._tPOVcall)/_.POVtransitionDuration,_._tPOVprogress>=1)return _._tPOVcall=-1,ATON.XR._currPos.copy(ATON.XR._reqPos),console.log("XR height"+ATON.XR._currPos.y),console.log("HMD height"+_._currPOV.pos.y),void ATON.fireEvent("POVTransitionCompleted",_._reqPOV.id);ATON.XR._currPos.lerpVectors(ATON.XR._fromPos,ATON.XR._reqPos,_._tPOVprogress)}},syncCurrCamera:()=>{if(ATON.XR.isPresenting())return;let e=_._controls,t=_._camera,o=_._currPOV.pos,i=_._currPOV.target;_._mode!==_.MODE_DEVORI?(_._vDir.subVectors(i,o),_._vDir.normalize(),_._mode===_.MODE_FP?(e.target.copy(o),t.position.x=e.target.x-_._vDir.x*_.FP_EPS,t.position.y=e.target.y-_._vDir.y*_.FP_EPS,t.position.z=e.target.z-_._vDir.z*_.FP_EPS):(t.position.copy(o),e.target.copy(i))):t.position.copy(o)},update:()=>{_.syncCurrPOV(),_.handlePOV(),_.syncCurrCamera()},requestPOV:(e,t)=>{ATON._tPOVcall>=0||void 0!==e&&(ATON.fireEvent("POVTransitionRequested",e.id),void 0!==t&&(_.POVtransitionDuration=t),_._tPOVcall=ATON._clock.elapsedTime,ATON.XR.isPresenting()?(_._reqPOV.pos.copy(e.pos?e.pos:_._currPOV.pos),_._fromPOV.pos.copy(_._currPOV.pos),ATON.XR._reqPos.copy(e.pos?e.pos:_._currPOV.pos),ATON.XR._fromPos.copy(ATON.XR._currPos)):(_._reqPOV.pos.copy(e.pos?e.pos:_._currPOV.pos),_._reqPOV.target.copy(e.target?e.target:_._currPOV.target),_._reqPOV.fov=e.fov?e.fov:_._currPOV.fov,_._fromPOV.pos.copy(_._currPOV.pos),_._fromPOV.target.copy(_._currPOV.target),_._fromPOV.fov=_._currPOV.fov))},requestPOVbyBound:(e,t)=>{if(void 0===e)return;let o=new THREE.Vector3,i=3*e.radius;o.x=e.center.x-i*_._vDir.x,o.y=e.center.y-i*_._vDir.y,o.z=e.center.z-i*_._vDir.z;let r=(new ATON.POV).setPosition(o).setTarget(e.center);_.requestPOV(r,t)},requestPOVbyNode:(e,t)=>{if(void 0===e)return;let o=e.getBound();_.requestPOVbyBound(o,t)},requestRetarget:(e,t,o)=>{let i=new THREE.Vector3;if(void 0===t)i.lerpVectors(e,_._currPOV.pos,.8);else{let o=e.distanceTo(_._currPOV.pos);o*=.5,i.x=e.x+t.x*o,i.y=e.y+t.y*o,i.z=e.z+t.z*o}let r=e.distanceTo(i);ATON.FX.setDOFfocus(r);let s=(new ATON.POV).setPosition(i).setTarget(e).setFOV(_._currPOV.fov);_.requestPOV(s,o),console.log(s)},computeDefaultHome:e=>{void 0===e&&(e=new THREE.Vector3(1,.7,1));let t=ATON.getRootScene().getBound(),o=new THREE.Vector3(t.center.x+t.radius*e.x*1.5,t.center.y+t.radius*e.y*1.5,t.center.z+t.radius*e.z*1.5);_.homePOV=(new ATON.POV).setPosition(o).setTarget(t.center)},setHomePOV:e=>{_.homePOV=e},computeAndRequestDefaultHome:(e,t)=>{_.computeDefaultHome(t),_.requestPOV(_.homePOV,e)},requestHome:e=>{_.requestPOV(_.homePOV,e)},setAndRequestHomePOV:(e,t)=>{_.setHomePOV(e),_.requestPOV(e,t)},DeviceOrientationControls:function(e){let t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0,this.absolute=!1,this.alphaOffsetDevice=void 0,this.alphaOffsetScreen=void 0;let o=function(e){t.absolute||(t.deviceOrientation=e)},i=function(e){t.deviceOrientation=e,t.absolute=!0},r=function(){t.screenOrientation=window.orientation||0},s=function(){let e=new THREE.Vector3(0,0,1),t=new THREE.Euler,o=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,s,n,a,d){t.set(n,s,-a,"YXZ"),r.setFromEuler(t),r.multiply(i),r.multiply(o.setFromAxisAngle(e,-d))}}();this.connect=function(){r(),window.addEventListener("orientationchange",r,!1),window.addEventListener("deviceorientation",o,!1),window.addEventListener("deviceorientationabsolute",i,!1),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r,!1),window.removeEventListener("deviceorientation",o,!1),window.removeEventListener("deviceorientationabsolute",i,!1),t.enabled=!1},this.update=function(){if(!1===t.enabled)return;let e;if(e=t.deviceOrientation,e){let o=this.getDirection()?THREE.Math.degToRad(this.getDirection())+t.alphaOffset:0,i=e.beta?THREE.Math.degToRad(e.beta):0,r=e.gamma?THREE.Math.degToRad(e.gamma):0,n=t.screenOrientation?THREE.Math.degToRad(t.screenOrientation):0;s(t.object.quaternion,o,i,r,n)}},this.dispose=()=>{t.disconnect()},this.iOSOrientationPermission=()=>{"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission().then((e=>{console.log(e)})).catch(console.error)},this.getDirection=()=>void 0!==t.deviceOrientation.webkitCompassHeading?t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.getDirectionMap=()=>void 0!==t.deviceOrientation.webkitCompassHeading?360-t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.connect()}};const p=_;let h={STD_TELEP_DURATION:.03,HAND_R:0,HAND_L:1,MOBILE_DENSITY_F:.5,init:()=>{ATON._renderer.xr.enabled=!0,ATON._renderer.xr.setReferenceSpaceType("local"),ATON.device.isMobile?ATON._renderer.xr.setFramebufferScaleFactor(ATON._stdpxd*h.MOBILE_DENSITY_F):ATON._renderer.xr.setFramebufferScaleFactor(ATON._stdpxd),h._bPresenting=!1,h.currSession=null,h._sessionType="immersive-vr",h.rig=new THREE.Group,h.rig.add(ATON.Nav._camera),ATON._rootUI.add(h.rig),h._cam=void 0,h._currPos=h.rig.position,h._fromPos=new THREE.Vector3,h._reqPos=new THREE.Vector3,h.gControllers=void 0,h.controller0=void 0,h.controller1=void 0,h.controller0pos=new THREE.Vector3,h.controller1pos=new THREE.Vector3,h.controller0dir=new THREE.Vector3,h.controller1dir=new THREE.Vector3,h._lastPosR=void 0,h._lastPosL=void 0,h._pointerLineGeom=void 0,h._pointerLineMesh=void 0,h.gpad0=void 0,h.gpad1=void 0,h._urlHand=ATON.PATH_RES+"models/hand/hand.glb",ATON.on("XRselectStart",(e=>{e===h.HAND_R&&ATON._stdActivation()})),ATON.on("XRselectEnd",(e=>{})),ATON.on("XRsqueezeStart",(e=>{console.log("Squeeze "+e)})),ATON.on("VRC_IDassigned",(e=>{let t=ATON.getUINode("Rhand"),o=ATON.getUINode("Lhand"),i=ATON.MatHub.materials.avatars,r=i[e%i.length];o&&o.setMaterial(r),t&&t.setMaterial(r)}))},setSessionType:e=>{void 0!==e&&("immersive-vr"!==e&&"immersive-ar"!==e||(h._sessionType=e,console.log("Session type: "+e)))},isPresenting:()=>h._bPresenting,teleportOnQueriedPoint:()=>{if(!ATON.Nav.currentQueryValidForLocomotion())return!1;const e=ATON._queryDataScene.p;return ATON.Nav.requestPOV((new ATON.POV).setPosition(e.x,e.y+ATON.userHeight,e.z),h.STD_TELEP_DURATION),!0},setupQueryRay:e=>{void 0!==e&&(h.controller0?e.set(h.controller0pos,h.controller0dir):e.set(ATON.Nav.getCurrentEyeLocation(),ATON.Nav.getCurrentDirection()))},setRefSpaceLocation:e=>{h.rig.position.copy(e)},_setupControllerR:(e,t)=>{h.controller0||(h.controller0=e,console.log("R controller"),e.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",h.HAND_R)})),e.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",h.HAND_R)})),e.addEventListener("squeezestart",(()=>{ATON.fireEvent("XRsqueezeStart",h.HAND_R)})),e.addEventListener("squeezeend",(()=>{ATON.fireEvent("XRsqueezeEnd",h.HAND_R)})),h.setupControllerUI(h.HAND_R,t),ATON.fireEvent("XRcontrollerConnected",h.HAND_R))},_setupControllerL:(e,t)=>{h.controller1||(h.controller1=e,console.log("L controller"),e.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",h.HAND_L)})),e.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",h.HAND_L)})),e.addEventListener("squeezestart",(()=>{ATON.fireEvent("XRsqueezeStart",h.HAND_L)})),e.addEventListener("squeezeend",(()=>{ATON.fireEvent("XRsqueezeEnd",h.HAND_L)})),h.setupControllerUI(h.HAND_L,t),ATON.fireEvent("XRcontrollerConnected",h.HAND_L))},onSessionStarted:e=>{h.currSession||(e.addEventListener("end",h.onSessionEnded),console.log(h._sessionType+" session started."),ATON.MediaRec.stopMediaStreaming(),"immersive-ar"===h._sessionType&&ATON._renderer.xr.setReferenceSpaceType("local"),ATON._renderer.xr.setSession(e).then((()=>{h.currSession=e,console.log(h.currSession),"immersive-ar"===h._sessionType&&(ATON._mainRoot.background=null,ATON._mMainPano&&(ATON._mMainPano.visible=!1));for(let e=0;e<2;e++){const t=ATON._renderer.xr.getController(e);void 0===t||t.userData.bXRconfig||(t.visible=!1,t.userData.bXRconfig=!0,t.addEventListener("connected",(e=>{let o=e.data.handedness;console.log("Hand "+o),"left"===o?h._setupControllerL(t,!0):"right"===o?h._setupControllerR(t,!0):(t.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",h.HAND_R),console.log("Head-aligned select")})),t.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",h.HAND_R)})),ATON.fireEvent("XRcontrollerConnected",h.HAND_R))})))}h.rig.add(ATON.Nav._camera),h.setRefSpaceLocation(ATON.Nav._currPOV.pos),console.log(ATON.Nav._currPOV.pos),h._bPresenting=!0,console.log("XR now presenting"),ATON.fireEvent("XRmode",!0),ATON.SUI.getSelectorRadius()>.5&&ATON.SUI.setSelectorRadius(.5);let t=ATON._renderer.xr.getCamera();ATON.Nav._updCamera(t),setTimeout((()=>{ATON.SUI.getSelectorRadius()>.5&&ATON.SUI.setSelectorRadius(.5)}),2e3)})))},onSessionEnded:()=>{h.currSession.removeEventListener("end",h.onSessionEnded),h.currSession=null,h._bPresenting=!1,h.setRefSpaceLocation(new THREE.Vector3(0,0,0)),ATON.fireEvent("XRmode",!1),ATON.MediaRec.stopMediaStreaming(),ATON.Nav.requestHome(),ATON.Nav._updCamera(),console.log("Quit XR")},toggle:e=>{if(h.setSessionType(e),ATON.device.xrSupported[h._sessionType])if(null===h.currSession){let e={optionalFeatures:[]};if("immersive-ar"===h._sessionType){e.requiredFeatures=["hit-test"];let t=document.createElement("div");t.style.display="none",document.body.appendChild(t),e.optionalFeatures.push("dom-overlay"),e.domOverlay={root:t}}navigator.xr.requestSession(h._sessionType,e).then(h.onSessionStarted)}else h.currSession.end()},setupControllerUI:(e,t)=>{let o,i;if(void 0===h.gControllers&&(h.gControllers=ATON.createUINode(),h.gControllers.disablePicking(),h.rig.add(h.gControllers)),e===h.HAND_L?(h.gControllers.add(h.controller1),t&&(i=ATON.createUINode("Lhand").load(h._urlHand).setMaterial(ATON.MatHub.materials.controllerRay).setScale(-1,1,1),h.controller1.add(i))):(h.gControllers.add(h.controller0),t&&(h._pointerLineGeom=new THREE.CylinderBufferGeometry(.003,.003,1,4),h._pointerLineGeom.rotateX(-Math.PI/2),h._pointerLineGeom.translate(0,0,-.5),h._pointerLineMesh=new THREE.Mesh(h._pointerLineGeom,ATON.MatHub.materials.controllerRay),h.controller0.add(h._pointerLineMesh),h._pointerLineMesh.visible=!1,o=ATON.createUINode("Rhand").load(h._urlHand).setMaterial(ATON.MatHub.materials.controllerRay),h.controller0.add(o))),void 0!==ATON.VRoadcast.uid&&t){let t=ATON.MatHub.materials.avatars,r=t[ATON.VRoadcast.uid%t.length];e===h.HAND_L?i.setMaterial(r):o.setMaterial(r)}},switchHands:()=>{let e=h.controller1;h.controller1=h.controller0,h.controller0=e;for(let e in h.controller0.children)h.controller0.remove(h.controller0.children[e]);for(let e in h.controller1.children)h.controller1.remove(h.controller1.children[e]);h.gControllers.removeChildren(),h.setupControllerUI(h.HAND_L),h.setupControllerUI(h.HAND_R),console.log("VR controllers switched")},getControllerSpace:e=>{1===e?h.getControllerGrip(1):h.getControllerGrip(0)},getControllerWorldLocation:e=>1===e?h.controller1pos:h.controller0pos,getControllerWorldDirection:e=>1===e?h.controller1dir:h.controller0dir,_deltaMotionController:e=>{if(e===h.HAND_L&&void 0===h._lastPosL)return;if(e===h.HAND_R&&void 0===h._lastPosR)return;let t=e===h.HAND_L?h.controller1pos:h.controller0pos,o=e===h.HAND_L?h._lastPosL:h._lastPosR;THREE.Vector3(t.x-o.x,t.y-o.y,t.z-o.z).lengthSq(),e===h.HAND_L?h._lastPosL=t:h._lastPosR=t},update:()=>{h.controller0&&h.controller0.visible&&(h.controller0.getWorldPosition(h.controller0pos),h.controller0.getWorldDirection(h.controller0dir),h.controller0dir.negate()),h.controller1&&h.controller1.visible&&(h.controller1.getWorldPosition(h.controller1pos),h.controller1.getWorldDirection(h.controller1dir),h.controller1dir.negate())}};const T=h;let v={STD_BTN_SIZE:.1};v.Button=class extends t{constructor(e,t=1,o=1){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.switchColor=ATON.MatHub.colors.green,this.baseOpacity=.5,this.hoverOpacity=.8,this._bSwitched=!1,this.container=new ThreeMeshUI.Block({width:.1*t,height:.1,padding:.01,borderRadius:.02,backgroundColor:this.baseColor,backgroundOpacity:this.baseOpacity,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",alignContent:"center"}),this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"",fontSize:.02*o,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText);let i=.9*ATON.SUI.STD_BTN_SIZE*t,r=.9*ATON.SUI.STD_BTN_SIZE;this._trigger=new THREE.Mesh(new THREE.PlaneGeometry(i,r,2),ATON.MatHub.materials.fullyTransparent),this._trigger.position.set(0,0,.002),this.add(this._trigger),this.onHover=()=>{this.container.set({backgroundOpacity:this.hoverOpacity})},this.onLeave=()=>{this.container.set({backgroundOpacity:this.baseOpacity})},this.enablePicking()}setBaseColor(e){return this.baseColor=e,this._bSwitched||this.container.set({backgroundColor:this.baseColor}),this}setSwitchColor(e){return this.switchColor=e,this._bSwitched&&this.container.set({backgroundColor:this.switchColor}),this}setBackgroundOpacity(e){return this.container.set({backgroundOpacity:e}),this.baseOpacity=e,this}setText(e){return this.uiText.set({content:e}),this}switch(e){return this._bSwitched=e,e?this.container.set({backgroundColor:this.switchColor}):this.container.set({backgroundColor:this.baseColor}),this}setIcon(e,t){return ATON.Utils.textureLoader.load(e,(e=>{this._trigger.material=new THREE.MeshStandardMaterial({map:e,transparent:!0,depthWrite:!1}),t&&(this.setBackgroundOpacity(0),this.hoverOpacity=0),this.uiText.position.set(0,-.035,0)})),this}},v.Label=class extends t{constructor(e){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.container=new ThreeMeshUI.Block({width:.2,height:.05,padding:.001,borderRadius:.01,backgroundColor:this.baseColor,backgroundOpacity:.5,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",alignContent:"center"}),this.container.position.z=.05,this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"Label",fontSize:.03,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText)}setBaseColor(e){return this.baseColor=e,this.container.set({backgroundColor:this.baseColor}),this}setTextColor(e){return this.uiText.set({fontColor:e}),this}setText(e){return this.uiText.set({content:e}),this}},v.init=()=>{v.mainSelector=ATON.createUINode(),v._mSelectorSphere=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("selector")),v._mSelectorSphere.renderOrder=100,v.mainSelector.add(v._mSelectorSphere),v.mainSelector.disablePicking(),v.setSelectorRadius(.05),v.mainSelector.visible=!1,ATON._rootUI.add(v.mainSelector),v.fpTeleport=ATON.createUINode();let e=new THREE.CylinderBufferGeometry(.4,.4,.9,32,1,!0),t=new THREE.Mesh(e,ATON.MatHub.getMaterial("teleportLoc"));t.renderOrder=100,v.fpTeleport.add(t),v.fpTeleport.disablePicking(),v.fpTeleport.visible=!1,ATON._rootUI.add(v.fpTeleport),v.PATH_FONT_JSON=ATON.PATH_RES+"fonts/custom-msdf.json",v.PATH_FONT_TEX=ATON.PATH_RES+"fonts/custom.png",v.gMeasures=ATON.createUINode(),v._prevMPoint=void 0,v._measLabels=[],ATON._rootUI.add(v.gMeasures);let o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3,new THREE.Vector3]);v._measLine=new THREE.Line(o,ATON.MatHub.getMaterial("measurement")),v._measLine.visible=!1,ATON._rootUI.add(v._measLine),v.gPoints=ATON.createUINode(),ATON._rootUI.add(v.gPoints),v.buildInfoNode(),v.bShowInfo=!0,v._labelScale=ATON.Utils.isMobile()?50:60,v._labelScaleVR=2,ATON.on("SemanticNodeHover",(e=>{v.setInfoNodeText(e),v.gSemIcons&&v.gSemIcons.hide()})),ATON.on("SemanticNodeLeave",(e=>{v.gSemIcons&&v.gSemIcons.show()})),v._sync=0},v.enableLPIcons=()=>{v.gLPIcons=ATON.createUINode(),v.gLPIcons.disablePicking(),ATON._rootUI.add(v.gLPIcons)},v.enableSemIcons=()=>{v.gSemIcons=ATON.createUINode(),v.gSemIcons.disablePicking(),ATON._rootUI.add(v.gSemIcons)},v.setSelectorRadius=e=>{v._selectorRad=e,v.mainSelector.scale.set(e,e,e)},v.getSelectorRadius=()=>v._selectorRad,v.setSelectorModel=(e,t)=>{void 0!==e&&(v.mainSelector.removeChildren(),v.mainSelector.load(e).disablePicking(),t&&v.mainSelector.setMaterial(ATON.MatHub.getMaterial("selector")))},v.setSelectorColor=(e,t)=>{ATON.MatHub.materials.selector.uniforms.color.value=e,void 0!==t&&(ATON.MatHub.materials.selector.uniforms.opacity.value=t)},v.addSemIcon=(e,t)=>{if(void 0===v.gSemIcons)return;let o=(new THREE.Box3).setFromObject(t),i=new THREE.Sphere;o.getBoundingSphere(i);let r=new THREE.Sprite(ATON.MatHub.semIcon);r.position.copy(i.center),r.scale.set(.035,.035,1),r.name=e,v.gSemIcons.add(r)},v.addLPIcon=e=>{if(void 0===v.gLPIcons)return;let t=e._near,o=new THREE.Sprite(ATON.MatHub.lpIcon);o.position.copy(e.pos),o.scale.set(.1,.1,.1);let i=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.lp);i.scale.set(t,t,t),i.position.copy(e.pos),v.gLPIcons.add(o),v.gLPIcons.add(i)},v.setSemIconsOpacity=e=>{ATON.MatHub.semIcon.opacity=void 0===e?1:e},v.buildInfoNode=()=>{v.infoNode=ATON.createUINode(),v.infoNode.attachToRoot(),v.infoContainer=new ThreeMeshUI.Block({width:.15,height:.05,padding:.01,borderRadius:.02,backgroundColor:ATON.MatHub.colors.black,fontFamily:v.PATH_FONT_JSON,fontTexture:v.PATH_FONT_TEX,alignContent:"center",justifyContent:"center"}),v.infoNode.add(v.infoContainer),v.infoNodeText=new ThreeMeshUI.Text({content:"Info",fontSize:.02,fontColor:ATON.MatHub.colors.white}),v.infoContainer.add(v.infoNodeText)},v.getInfoNode=()=>v.infoNode,v.setInfoNodeText=e=>{v.bShowInfo&&(v.infoNodeText.set({content:e}),ThreeMeshUI.update())},v.createToolbar=(e,t)=>{let o=ATON.createUINode(),i=e.length,r=.3*v.STD_BTN_SIZE,s=new ThreeMeshUI.Block({width:v.STD_BTN_SIZE*i*1.1+r,height:v.STD_BTN_SIZE+r,padding:.01,borderRadius:.02,backgroundColor:t||ATON.MatHub.colors.black,backgroundOpacity:.3,fontFamily:v.PATH_FONT_JSON,fontTexture:v.PATH_FONT_TEX,alignContent:"center",justifyContent:"center"}),n=.5*i*v.STD_BTN_SIZE*1.1;n-=.5*v.STD_BTN_SIZE;for(let t=0;t<i;t++){let o=e[t];o&&(o.position.set(t*v.STD_BTN_SIZE*1.1-n,0,.005),s.add(o))}return o.add(s),o},v.addMeasurementPoint=e=>{if(void 0===e)return;let t=.01,o=.001;if(void 0===v._prevMPoint){v._prevMPoint=e;let t=v._measLine.geometry.attributes.position.array;return t[0]=e.x,t[1]=e.y,void(t[2]=e.z)}v._measLine.visible=!1;let i=v._prevMPoint.distanceTo(e);t*=i,o*=i;let r=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("measurement"));r.position.copy(v._prevMPoint),r.scale.set(t,t,t),v.gMeasures.add(r);let s=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("measurement"));s.position.copy(e),s.scale.set(t,t,t),v.gMeasures.add(s);let n=2*i,a=(new THREE.BufferGeometry).setFromPoints([v._prevMPoint,e]);v.gMeasures.add(new THREE.Line(a,ATON.MatHub.getMaterial("measurement")));let d=new v.Label;d.setBaseColor(ATON.MatHub.colors.white).setTextColor(ATON.MatHub.colors.black),d.setPosition(.5*(v._prevMPoint.x+e.x),.5*(v._prevMPoint.y+e.y),.5*(v._prevMPoint.z+e.z)),d.setScale(n).setText(ATON.Utils.getHumanReadableDistance(i)),v.gMeasures.add(d),v._measLabels.push(d);let l={};return l.A=v._prevMPoint.clone(),l.B=e.clone(),v._prevMPoint=void 0,l},v.clearMeasurements=()=>{v.gMeasures.removeChildren(),v._measLabels=[]},v._updateMeasurements=()=>{if(!(v._measLabels.length<=0))for(let e in v._measLabels)v._measLabels[e].orientToCamera()},v.update=()=>{if(ATON.Nav.isTransitioning()||ATON._bPauseQuery)v.infoNode.visible=!1;else{if(ThreeMeshUI.update(),v._prevMPoint){if(ATON._queryDataScene){let e=v._measLine.geometry.attributes.position.array;e[3]=ATON._queryDataScene.p.x,e[4]=ATON._queryDataScene.p.y,e[5]=ATON._queryDataScene.p.z,v._measLine.geometry.attributes.position.needsUpdate=!0}v._measLine.visible=!0}else v._measLine.visible=!1;if(ATON._queryDataScene&&!ATON.Nav._bInteracting?(v.mainSelector.visible=!0,v.mainSelector.position.copy(ATON._queryDataScene.p)):v.mainSelector.visible=!1,v.gSemIcons&&(ATON.Nav._bInteracting?v.gSemIcons.hide():void 0===ATON._hoveredSemNode&&v.gSemIcons.show()),ATON.Nav.isOrbit()&&!ATON.XR._bPresenting||!ATON.Nav.currentQueryValidForLocomotion()?v.fpTeleport.visible=!1:(v.fpTeleport.visible=!0,v.fpTeleport.position.copy(ATON._queryDataScene.p)),ATON.XR._pointerLineMesh){let e=0;ATON._queryDataScene&&(e=ATON._queryDataScene.d),ATON._queryDataUI&&(e<=0||ATON._queryDataUI.d<e)&&(e=ATON._queryDataUI.d,v.mainSelector.visible=!1,v.fpTeleport.visible=!1),e>0?(ATON.XR._pointerLineMesh.visible=!0,ATON.XR._pointerLineMesh.scale.set(1,1,e)):ATON.XR._pointerLineMesh.visible=!1}if(v._updateMeasurements(),ATON._queryDataSem){if(ATON.XR._bPresenting)ATON.XR.controller0?(v.infoNode.position.copy(ATON.XR.controller0pos),v.infoNode.position.x-=.1*ATON.XR.controller0dir.x,v.infoNode.position.y-=.1*ATON.XR.controller0dir.y,v.infoNode.position.z-=.1*ATON.XR.controller0dir.z,v.infoNode.setScale(v._labelScaleVR)):(v.infoNode.position.lerpVectors(ATON._queryDataSem.p,ATON.Nav._currPOV.pos,.5),v.infoNode.setScale(ATON._queryDataSem.d*v._labelScaleVR));else{v.infoNode.position.lerpVectors(ATON._queryDataSem.p,ATON.Nav._currPOV.pos,.2);const e=ATON._queryDataSem.d*(ATON.Nav._currPOV.fov/v._labelScale);v.infoNode.setScale(e)}v.infoNode.orientToCamera(),v.bShowInfo&&(v.infoNode.visible=!0),ATON.VRoadcast._bStreamFocus||(v.mainSelector.visible=!1)}else v.infoNode.visible=!1;if(v.mainSelector.visible&&ATON.VRoadcast._bStreamFocus){let e=v._selectorRad*(1+.2*Math.cos(10*ATON._clock.elapsedTime));v.mainSelector.scale.set(e,e,e)}}};const m=v;let O={USER_STATE_FREQ:.25,REPLICATED_EVT:"EREP",THRES_STATE_POS:.01,THRES_STATE_ORI:.08};O.Avatar=class extends t{constructor(e){super(void 0,ATON.NTYPES.UI),this.userid=e,this.username=void 0,this.message="...",this._auTalk=new THREE.PositionalAudio(ATON.AudioHub._listener),this._auTalk.setRefDistance(30),this.add(this._auTalk),this._bPlayingAudio=!1,this._auChunks=[],this._tStateCall=-1,this._tProgress=0,this._tFocCall=-1,this._currFocusPos=new THREE.Vector3,this._tgtFocusPos=void 0,this._currState={},this._currState.position=new THREE.Vector3,this._currState.quaternion=new THREE.Quaternion,this._tgtState=void 0,this.realize()}setTalkDistance(e){e>0&&this._auTalk.setRefDistance(e)}getAvatarMaterialByUID(e){let t=ATON.MatHub.materials.avatars;return t[e%t.length]}realize(){let e=new THREE.SphereGeometry(.2,16,16);this.usermaterial=this.getAvatarMaterialByUID(this.userid);let t=new THREE.Mesh(e,this.usermaterial);this.usermeshnode=ATON.createUINode(),this.usermeshnode.add(t),this.usermeshnode.setMaterial(this.usermaterial),this.usermeshnode.setCloneOnLoadHit(!1),this.userauinode=new THREE.Sprite(ATON.VRoadcast.uspritemats[this.userid%ATON.VRoadcast.uspritemats.length]),this.userauinode.position.set(0,0,0),this.userauinode.visible=!1,this.userfpnode=new THREE.Sprite(ATON.VRoadcast.ufocmats[this.userid%ATON.VRoadcast.ufocmats.length]),this.userfpnode.position.set(0,0,0),this.userfpnode.visible=!1,this.userlabelnode=ATON.createUINode(),this.labelcontainer=new ThreeMeshUI.Block({width:.7,height:.25,padding:.03,borderRadius:.05,backgroundColor:ATON.MatHub.colors.black,fontFamily:ATON.PATH_RES+"fonts/custom-msdf.json",fontTexture:ATON.PATH_RES+"fonts/custom.png"}),this.userlabelnode.position.y=.4,this.userlabelnode.add(this.labelcontainer),this.usernametext=new ThreeMeshUI.Text({content:"User #"+this.userid,fontSize:.09,fontColor:ATON.VRoadcast.ucolors[this.userid%ATON.VRoadcast.ucolors.length]}),this.usernametext.position.y=0,this.usermessagetext=new ThreeMeshUI.Text({content:"\nHello World!",fontSize:.03,fontColor:ATON.MatHub.colors.white}),this.usermessagetext.position.y=-.03,this.labelcontainer.add(this.usernametext),this.labelcontainer.add(this.usermessagetext),this.add(this.usermeshnode),this.add(this.userlabelnode),this.add(this.userauinode),void 0===ATON.VRoadcast._focNodes[this.userid]&&(ATON.VRoadcast._focNodes[this.userid]=this.userfpnode,ATON.VRoadcast.focGroup.add(this.userfpnode))}destroy(){this.usermaterial&&this.usermaterial.dispose(),this.usermeshnode&&this.usermeshnode.dispose(),this.userauinode&&this.userauinode.dispose(),this.userfpnode&&this.userfpnode.dispose(),ATON.VRoadcast._focNodes[this.userid]&&ATON.VRoadcast._focNodes[this.userid].dispose(),this.userlabelnode&&this.userlabelnode.dispose(),this.labelcontainer&&this.labelcontainer.dispose(),this.usernametext&&this.usernametext.dispose(),this.usermessagetext&&this.usermessagetext.dispose(),this.dispose()}loadRepresentation(e){let t=this;return void 0!==t.usermeshnode.children[0]&&t.usermeshnode.remove(t.usermeshnode.children[0]),t.usermeshnode.load(e),this}setUsername(e){return this.username=e,this.usernametext.set({content:e}),this}getUsername(){if(void 0!==this.userid)return void 0===this.username?"User #"+this.userid:this.username}setMessage(e){return this.message=e,this.usermessagetext.set({content:"\n"+e}),this}setTalkVolume(e){if(void 0!==e)if(e>0){this.userauinode.visible=!0;let t=.1+.03*e;this.userauinode.scale.set(t,t,t)}else this.userauinode.visible=!1;else this.userauinode.visible=!1}hideFocalPoint(){this.userfpnode.visible=!1}requestFocus(e){this._tFocCall>=0||(this._tFocCall=ATON._clock.elapsedTime,this._currFocusPos.copy(this.userfpnode.position),this._tgtFocusPos=new THREE.Vector3(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),this._tgtFocusRad=2*parseFloat(e[3]),this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),this.userfpnode.visible=!0)}handleFocusTransition(){if(this._tFocCall<0)return;let e=ATON.VRoadcast.USER_STATE_FREQ,t=(ATON._clock.elapsedTime-this._tFocCall)/e;if(t>=1)return this._tFocCall=-1,this.userfpnode.position.copy(this._tgtFocusPos),this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),void(this.userfpnode.visible=!0);this.userfpnode.position.lerpVectors(this._currFocusPos,this._tgtFocusPos,t),this.userfpnode.visible=!0}requestStateTransition(e){this._tStateCall>=0||(this._tStateCall=ATON._clock.elapsedTime,this._currState.position.copy(this.position),this._currState.quaternion.copy(this.quaternion),this._tgtState=e)}handleStateTransition(){if(this._tStateCall<0)return;let e=ATON.VRoadcast.USER_STATE_FREQ;this._tProgress=e<=0?1:(ATON._clock.elapsedTime-this._tStateCall)/e;let t=this._currState,o=this._tgtState;if(this._tProgress>=1)return this._tStateCall=-1,this.position.copy(o.position),void this.usermeshnode.quaternion.copy(o.quaternion);this.position.lerpVectors(t.position,o.position,this._tProgress),this.usermeshnode.quaternion.slerp(o.quaternion,this._tProgress)}update(){if(this.handleStateTransition(),this.userfpnode.visible){this.handleFocusTransition();let e=this.userfpnode.scale.x;e>.001?this.userfpnode.scale.set(.99*e,.99*e,.99*e):this.userfpnode.visible=!1}let e=ATON.Nav._camera,t=ATON.Nav._currPOV.pos;if(void 0===e||void 0===t)return;this.userlabelnode.orientToCamera();let o=this.userauinode.scale.x;o*=.99,o>.01?this.userauinode.scale.set(o,o,o):this.userauinode.visible=!1}_handleTalk(){if(this._bPlayingAudio)return;if(this._auChunks.length<1)return;let e=this._auChunks.shift(),t=new Audio;t.src=e.data,t.play(),this._bPlayingAudio=!0,t.onended=()=>{this._bPlayingAudio=!1},this.setTalkVolume(5)}},O.init=()=>{O.address=window.location.origin,O.initMaterials(),O.socket=void 0,O._connected=!1,O._username=void 0,O.uid=void 0,O._bStreamFocus=!1,O._numUsers=1,O.avatarList=[],O.avaGroup=ATON.createUINode("avatars"),O.avaGroup.attachToRoot(),O.focGroup=ATON.createUINode("focus"),O.focGroup.attachTo(O.avaGroup),O._focNodes=[],O.bSendState=!0,window.setInterval(O.sendState,1e3*O.USER_STATE_FREQ),O._lastStateSent=void 0,O._bShowAvaG=!0,console.log("VRoadcast initialized"),O.enableChatLog()},O.enableChatLog=()=>{O._elChat=$("<div></div>").text("")},O.getNumUsers=()=>O._numUsers,O.initMaterials=()=>{O.ucolors=[],O.ucolors.push(new THREE.Color(1,0,0)),O.ucolors.push(new THREE.Color(1,1,0)),O.ucolors.push(new THREE.Color(0,1,0)),O.ucolors.push(new THREE.Color(0,1,1)),O.ucolors.push(new THREE.Color(0,0,1)),O.ucolors.push(new THREE.Color(1,0,1)),O.ucolorsdark=[],O.ucolorsdark.push(new THREE.Color(.2,0,0)),O.ucolorsdark.push(new THREE.Color(.2,.2,0)),O.ucolorsdark.push(new THREE.Color(0,.2,0)),O.ucolorsdark.push(new THREE.Color(0,.2,.2)),O.ucolorsdark.push(new THREE.Color(0,0,.2)),O.ucolorsdark.push(new THREE.Color(.2,0,.2)),O.ucolorhex=[],O.ucolorhex.push("#F00"),O.ucolorhex.push("#FF0"),O.ucolorhex.push("#0F0"),O.ucolorhex.push("#0FF"),O.ucolorhex.push("#00F"),O.ucolorhex.push("#F0F");let e=ATON.MatHub.materials;e.avatars=[];let t=ATON.MatHub.materials.defUI.clone();t.uniforms.color.value=O.ucolors[0],e.avatars.push(t);for(let o=1;o<O.ucolors.length;o++){let i=t.clone();i.uniforms.color.value=O.ucolors[o],e.avatars.push(i)}O.uspritemats=[];let o=(new THREE.TextureLoader).load(ATON.PATH_RES+"useraui.png");for(let e=0;e<O.ucolors.length;e++){let t=new THREE.SpriteMaterial({map:o,depthWrite:!1,color:O.ucolors[e]});t.sizeAttenuation=!0,O.uspritemats.push(t)}O.ufocmats=[];let i=(new THREE.TextureLoader).load(ATON.PATH_RES+"focus.png");for(let e=0;e<O.ucolors.length;e++){let t=new THREE.SpriteMaterial({map:i,depthWrite:!1,depthTest:!1,color:O.ucolors[e]});t.sizeAttenuation=!0,O.ufocmats.push(t)}},O.fireEvent=(e,t)=>{if(!O._connected)return;let o=O.socket;o&&o.emit(O.REPLICATED_EVT,{e,d:t})},O.on=(e,t)=>{if(void 0===t)return;let o=ATON.EventHub.evNetwork;void 0===o[e]&&(o[e]=[]),o[e].push(t)},O.isConnected=()=>void 0!==O.socket&&O._connected,O.hasID=()=>void 0!==O.uid,O.log=e=>{if(!O._connected)return;let t=O.socket;t&&t.emit("LOG",e)},O.joinSession=e=>{O.socket&&(void 0===e&&(e=ATON.SceneHub.currID),void 0!==e?(console.log("Joining VRC session "+e+"..."),O.socket.emit("SENTER",e)):console.log("VRC ERROR: current session ID is undefined"))},O.requestSceneState=()=>{O.socket&&O.socket.emit("SSTATE")},O.setAvatarsVisibility=e=>{O._bShowAvaG=e,e?O.avaGroup.show():O.avaGroup.hide()},O.connect=e=>{if(O._connected)return;e&&(O.address=e);let t={};"https:"===window.location.protocol?(t.path="/svrc/socket.io",t.secure=!0,t.rejectUnauthorized=!1):t.path="/vrc/socket.io",O.socket=io.connect(O.address,t),void 0!==O.socket&&(O._connected=O.socket.connected,O._registerSocketHandlers())},O.disconnect=()=>{void 0!==O.socket&&(O._numUsers=1,O.socket.disconnect(),O._connected=!1)},O._onConnected=()=>{},O.setUsername=e=>{O._username=e,void 0!==O.socket&&void 0!==O.uid&&(O._elChat&&O._elChat.append("<i>Your username is now: "+e+"</i><br>"),O.socket.emit("UNAME",e))},O.setMessage=e=>{O._msg=e,void 0!==O.socket&&void 0!==O.uid&&(O._elChat&&(O._elChat.append("<span style='color:"+O.ucolorhex[O.uid%6]+"'><b>YOU</b>: "+e+"</span><br>"),O._elChat.scrollTop(O._elChat.scrollHeight)),O.socket.emit("UMSG",e))},O._registerSocketHandlers=()=>{O.socket.on("connect",(()=>{O._connected=!0,void 0!==ATON.SceneHub.currID&&O.joinSession(),console.log("Connected to VRC service!"),ATON.fireEvent("VRC_Connected"),O._onConnected()})),O.socket.on("disconnect",(()=>{O._connected=!1,O.uid=void 0,O.avaGroup.hide(),O._elChat&&O._elChat.append("<i>YOU disconnected from VRoadcast service</i><br>"),console.log("VRC disconnected!"),ATON.fireEvent("VRC_Disconnected")})),O.socket.on(O.REPLICATED_EVT,(e=>{let t=e.e,o=e.d,i=ATON.EventHub.evNetwork[t];ATON.EventHub.executeHandlers(i,o)})),O.socket.on("ID",(e=>{console.log("Your ID is "+e),O.uid=e,O._bShowAvaG&&O.avaGroup.show(),O._elChat&&O._elChat.append("<i>Your ID is #"+e+"</i><br>"),O.requestSceneState(),ATON.fireEvent("VRC_IDassigned",e)})),O.socket.on("SSTATE",(e=>{O._numUsers=e.numUsers,console.log("Num. users: "+O._numUsers),ATON.fireEvent("VRC_SceneState",e)})),O.socket.on("UENTER",(e=>{let t=e;console.log("User #"+t+" entered the scene"),O._elChat&&O._elChat.append("<i>User #"+t+" entered the scene</i><br>"),O.touchAvatar(t),O.requestSceneState(),ATON.fireEvent("VRC_UserEnter",t)})),O.socket.on("ULEAVE",(e=>{let t=e;if(void 0===t)return;let o=O.avatarList[t];o&&o.hide(),console.log("User #"+t+" left the scene"),O._elChat&&O._elChat.append("<i>User #"+t+" left the scene</i><br>"),O.requestSceneState(),ATON.fireEvent("VRC_UserLeave",t)})),O.socket.on("USTATE",(e=>{if(!O._bShowAvaG)return;let t=O.decodeState(e),o=t.userid;O.touchAvatar(o).requestStateTransition(t)})),O.socket.on("UFOCUS",(e=>{let t=e.uid,o=e.fp;O.touchAvatar(t).requestFocus(o)})),O.socket.on("UNAME",(e=>{let t=e.uid,o=e.name;void 0!==t&&(O.touchAvatar(t).setUsername(o),console.log("User #"+t+" changed username to: "+o),O._elChat&&O._elChat.append("<i>User #"+t+" changed username to: "+o+"</i><br>"))})),O.socket.on("UMSG",(e=>{let t=e.uid,o=e.msg;if(void 0===t)return;let i=O.touchAvatar(t);i.setMessage(o),console.log("User #"+t+": "+o),O._elChat&&O._elChat.append("<span style='color:"+O.ucolorhex[t%6]+"'><b>"+i.getUsername()+"</b>: "+o+"</span><br>")})),O.socket.on("UTALK",(e=>{let t=e.uid;if(void 0===t)return;let o=e.audio,i=O.touchAvatar(t);i.setTalkVolume(5),i._auTalk.isPlaying&&i._auTalk.stop(),ATON.AudioHub._loader.load(o,(e=>{i._auTalk.setBuffer(e),i._auTalk.setLoop(!1),i._auTalk.play()})),o=null}))},O.encodeState=e=>{if(!e)return;let t=new Float32Array(6);t[0]=e.position.x,t[1]=e.position.y,t[2]=e.position.z;var o=new Int8Array(t.buffer);return o[16]=128*e.quaternion.x,o[17]=128*e.quaternion.y,o[18]=128*e.quaternion.z,o[19]=128*e.quaternion.w,o[20]=e.userid,o},O.decodeState=e=>{let t={},o=new Int8Array(e);return t.userid=o[20],t.quaternion=new THREE.Quaternion(o[16]/128,o[17]/128,o[18]/128,o[19]/128),o=new Float32Array(e),t.position=new THREE.Vector3(o[0],o[1],o[2]),t},O.update=()=>{if(O._connected)for(let e=0;e<O.avatarList.length;e++){let t=O.avatarList[e];t&&t.visible&&t.update()}},O.setFocusStreaming=e=>{if(void 0!==e){if(e)return O._bStreamFocus||ATON.fireEvent("VRC_FocusStreamingStarted"),void(O._bStreamFocus=!0);{O._bStreamFocus&&ATON.fireEvent("VRC_FocusStreamingStopped");let e=ATON.SUI._selectorRad;ATON.SUI.mainSelector.scale.set(e,e,e),O._bStreamFocus=!1}}},O.sendState=()=>{if(!O.bSendState)return;if(void 0===O.uid)return;if(!O.socket||!O._connected)return;let e=ATON.Nav._currPOV;if(!e)return;let t=ATON.getSceneQueriedPoint();if(O._bStreamFocus&&void 0!==t){let e=t.x.toPrecision(5),o=t.y.toPrecision(5),i=t.z.toPrecision(5),r=ATON.SUI.getSelectorRadius().toPrecision(5);O.socket.emit("UFOCUS",[e,o,i,r])}let o={};if(o.position=new THREE.Vector3,o.quaternion=new THREE.Quaternion,o.position.copy(e.pos),o.quaternion.copy(ATON.Nav._qOri),o.userid=O.uid,void 0!==O._lastStateSent){let t=O._lastStateSent.position,o=O._lastStateSent.quaternion,i=t.distanceToSquared(e.pos),r=o.angleTo(ATON.Nav._qOri);if(i<O.THRES_STATE_POS&&r<O.THRES_STATE_ORI)return}let i=O.encodeState(o);O.socket.emit("USTATE",i),O._lastStateSent=o},O.getAvatar=e=>O.avatarList[e],O.touchAvatar=e=>{if(void 0===O.avatarList[e]){let t=new O.Avatar(e);t.attachTo(O.avaGroup),t.loadRepresentation(ATON.PATH_RES+"models/vrc/head.gltf"),O.avatarList[e]=t}let t=O.avatarList[e];return t.visible||(O._numUsers++,ATON.fireEvent("VRC_UserEnter",e)),O._bShowAvaG&&t.show(),t},O.destroyAvatar=e=>{let t=O.avatarList[e];void 0!==t&&t.destroy()},O.clearAllAvatars=()=>{for(let e in O.avatarList)O.avatarList[e].hide()};const A=O;let N={FLOAT_PREC:5,init:()=>{N.bConvexBuilding=!1,N.convexPoints=[],N.convexNode=void 0,N.currConvexMesh=void 0,N.currSemNode=ATON.createSemanticNode(),N.currSemNode.disablePicking(),N.currSemNode.attachToRoot(),N.resetMaterial(),N._numShapes=0},resetMaterial:()=>{N.currMaterial=ATON.MatHub.getMaterial("semanticShapeHL")},setMaterial:e=>{void 0!==e&&(N.currMaterial=e)},addConvexPoint:e=>{if(void 0===e)return!1;if(N.convexPoints.length>0){let t=N.convexPoints[N.convexPoints.length-1];if(e.equals(t))return!1}N.convexPoints.push(e);let t=N.convexPoints.length,o=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("semanticShapeEdit"));if(o.position.copy(e),o.scale.set(.001,.001,.001),ATON.SUI.gPoints.add(o),t<4)return!1;let i=new THREE.ConvexGeometry(N.convexPoints),r=new THREE.Mesh(i,ATON.MatHub.getMaterial("semanticShapeEdit"));if(N.bConvexBuilding){let t=N.currConvexMesh;t.geometry.dispose(),t.geometry=i,ATON.Utils.setVectorPrecision(e,4),t.userData._convexPoints.push(e.x),t.userData._convexPoints.push(e.y),t.userData._convexPoints.push(e.z)}else{N.currSemNode.add(r),r.userData._convexPoints=[];for(let e=0;e<t;e++)ATON.Utils.setVectorPrecision(N.convexPoints[e],N.FLOAT_PREC),r.userData._convexPoints.push(N.convexPoints[e].x),r.userData._convexPoints.push(N.convexPoints[e].y),r.userData._convexPoints.push(N.convexPoints[e].z);N.currConvexMesh=r,N.bConvexBuilding=!0}return!0},undoConvexPoint:()=>{if(0!==N.convexPoints.length&&(N.convexPoints.pop(),N.currConvexMesh)){let e=N.currConvexMesh.userData;e._convexPoints&&e._convexPoints.pop()}},stopCurrentConvex:()=>{N.convexPoints=[],N.bConvexBuilding=!1,N.currSemNode.removeChildren(),ATON.SUI.gPoints.removeChildren()},getCurrentConvexShape:()=>N.currSemNode,isBuildingShape:()=>N.convexPoints.length>0,completeConvexShape:e=>{if(N.convexPoints=[],N.bConvexBuilding=!1,void 0===N.currSemNode)return;void 0===e&&(e="sem"+N._numShapes);let t=ATON.getSemanticNode(e)||ATON.createSemanticNode(e),o=N.currSemNode.children[0];return ATON.SUI.addSemIcon(e,o),t.add(o),t.setMaterial(ATON.MatHub.materials.semanticShape),t.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,N.currMaterial),t.enablePicking(),N.currSemNode.removeChildren(),N._numShapes++,ATON.SUI.gPoints.removeChildren(),ATON._bqSem=!0,t},createConvexShape:(e,t)=>{let o=new THREE.ConvexGeometry(t),i=new THREE.Mesh(o,ATON.MatHub.materials.semanticShape);i.userData._convexPoints=[];for(let e=0;e<t.length;e++){let o=t[e];ATON.Utils.setVectorPrecision(o,4),i.userData._convexPoints.push(o.x),i.userData._convexPoints.push(o.y),i.userData._convexPoints.push(o.z)}ATON.SUI.addSemIcon(e,i);let r=ATON.getOrCreateSemanticNode(e);return r.add(i),r.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,N.currMaterial),r.enablePicking(),ATON._bqSem=!0,r},addSurfaceConvexPoint:e=>{if(void 0===ATON._queryDataScene)return!1;void 0===e&&(e=.02);let t=ATON._queryDataScene.p,o=ATON.Nav.getCurrentEyeLocation();return t.lerpVectors(t,o,e),N.addConvexPoint(t),t},createSphere:(e,t,o)=>{if(void 0===t)return;if(void 0===o)return;void 0===e&&(e="sem"+N._numShapes);let i=ATON.getOrCreateSemanticNode(e),r=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.semanticShape),s=new THREE.Object3D;return s.position.copy(t),s.scale.set(o,o,o),s.add(r),ATON.SUI.addSemIcon(e,s),i.add(s),i.enablePicking(),i.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,N.currMaterial),N._numShapes++,ATON._bqSem=!0,i},createSurfaceSphere:e=>{if(!ATON._queryDataScene)return;let t=ATON._queryDataScene.p,o=ATON.SUI.getSelectorRadius();return N.createSphere(e,t,o)},deleteSemanticNode:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return!1;if(t.removeChildren(),void 0===ATON.SUI.gSemIcons)return!0;for(let t in ATON.SUI.gSemIcons.children){let o=ATON.SUI.gSemIcons.children[t];o&&o.name===e&&ATON.SUI.gSemIcons.removeChild(o)}return!0}};const g=N;let S={SEMSHAPE_SPHERE:0,SEMSHAPE_CONVEX:1,POPUP_DELAY:300,realize:()=>{S.PATH_RES_ICONS=ATON.PATH_RES+"icons/",S._bPopup=!1,S.popupBlurBG=0,S._userAuth={},S._bControlLight=!1,S._bControlSelScale=!1,S._cLightDir=new THREE.Vector3,S._auSemNode=void 0,S._auSemNodePlaying=!1,S._bReqHome=!1,S._vrcAddr=void 0,S._bVRCsetup=!1,S.urlParams=new URLSearchParams(window.location.search),S._uiSetupBase(),S._uiProfiles={},S._uiCurrProfile=void 0,S._selRanges=[.01,50],S._selRefRadius=.5,ATON.realize(),ATON.on("Fullscreen",(e=>{S.uiSwitchButton("fullscreen",e)}));let e=ATON.FE.urlParams.get("d");e&&e>0&&ATON.setDefaultPixelDensity(e);let t=ATON.FE.urlParams.get("dd");t&&t>0&&ATON.toggleDynamicDensity(!0)},_handleHomeReq:()=>{S._bReqHome||(S._bReqHome=!0,void 0!==ATON.Nav.homePOV?ATON.Nav.requestHome(1):ATON.Nav.computeAndRequestDefaultHome(.5))},addBasicLoaderEvents:()=>{ATON.on("NodeRequestFired",(()=>{$("#idLoader").show()})),ATON.on("SceneJSONLoaded",(()=>{ATON.SceneHub.getDescription()&&$("#btn-info").show(),void 0!==ATON.Nav.homePOV&&ATON.Nav.requestHome(1)})),ATON.on("AllNodeRequestsCompleted",(()=>{$("#idLoader").hide(),ATON._ccModels.length>0&&$("#btn-cc").show(),S.computeSelectorRanges(),ATON.Nav.isOrbit()&&ATON.SUI.setSelectorRadius(S._selRefRadius),S._handleHomeReq()})),ATON.addUpdateRoutine(S._update)},controlLight:e=>{S._bControlLight=e,ATON.Nav.setUserControl(!e)},controlSelectorScale:e=>{S._bControlSelScale=e,ATON._bPauseQuery=e,ATON.Nav.setUserControl(!e)},useMouseWheelToScaleSelector:e=>{void 0===e&&(e=.9),ATON.on("MouseWheel",(t=>{if(ATON._kModCtrl){let e=ATON.Nav.getFOV();return t>0?e+=1:e-=1,void ATON.Nav.setFOV(e)}if(ATON._kModShift){let o=ATON.SUI.mainSelector.scale.x;return t>0?o*=e:o/=e,o<S._selRanges[0]&&(o=S._selRanges[0]),o>S._selRanges[1]&&(o=S._selRanges[1]),void ATON.SUI.setSelectorRadius(o)}}))},loadSceneID:e=>{if(void 0===e)return;let t=ATON.PATH_RESTAPI_SCENE+e;ATON.SceneHub.load(t,e),$("meta[property=og\\:image]").attr("content",ATON.PATH_SCENES+e+"/cover.png"),$("meta[property=og\\:image\\:secure_url]").attr("content",ATON.PATH_SCENES+e+"/cover.png"),$("meta[property=og\\:image\\:type]").attr("content","image/png"),$("meta[property=og\\:image\\:width]").attr("content","200"),$("meta[property=og\\:image\\:height]").attr("content","200"),console.log(t)},_update:()=>{if(S._bControlLight){const e=ATON._screenPointerCoords.x,t=ATON._screenPointerCoords.y;S._cLightDir.x=-Math.cos(e*Math.PI),S._cLightDir.y=4*-t,S._cLightDir.z=-Math.sin(e*Math.PI),S._cLightDir.normalize(),ATON.setMainLightDirection(S._cLightDir)}},uiBasicSetup:()=>{S.uiAddButton("idTopToolbar","fullscreen",ATON.toggleFullScreen),ATON.Utils.isConnectionSecure()&&S.uiAddButton("idTopToolbar","vr",ATON.XR.toggle),S.uiAddButton("idBottomToolbar","home",(()=>{ATON.Nav.requestHome(.1)}))},_uiSetupBase:()=>{$("#idPopup").click(S.popupClose),$("#idLoader").html("<img src='"+ATON.PATH_RES+"loader.png'>")},uiAddButton:(e,t,o,i)=>{let r,s;t.endsWith(".png")?(r=t,s=t.slice(0,-4)):(r=S.PATH_RES_ICONS+t+".png",s=t);let n=$("<div id='btn-"+s+"' class='atonBTN' ><img src='"+r+"'></div>");$("#"+e).append(n),o&&n.click(o),i&&n.attr("title",i)},uiSwitchButton:(e,t)=>{t?$("#btn-"+e).addClass("switchedON"):$("#btn-"+e).removeClass("switchedON")},uiAddButtonHome:e=>{S.uiAddButton(e,"home",(()=>{ATON.Nav.requestHome(.3)}),"Home viewpoint")},uiAddButtonFirstPerson:e=>{S.uiAddButton(e,"fp",(()=>{ATON.Nav.isFirstPerson()?(ATON.Nav.setOrbitControl(),S.uiSwitchButton("fp",!1)):(ATON.Nav.setFirstPersonControl(),S.uiSwitchButton("fp",!0))}),"First-person navigation mode"),ATON.Nav.isFirstPerson()?S.uiSwitchButton("fp",!0):S.uiSwitchButton("fp",!1)},uiAddButtonVR:e=>{ATON.Utils.isConnectionSecure()&&S.uiAddButton(e,"vr",(()=>{ATON.XR.toggle("immersive-vr")}),"Immersive VR mode")},uiAddButtonAR:e=>{ATON.Utils.isConnectionSecure()&&S.uiAddButton(e,"ar",(()=>{ATON.XR.toggle("immersive-ar")}),"Immersive AR mode")},uiAddButtonDeviceOrientation:e=>{ATON.Utils.isConnectionSecure()&&ATON.Utils.isMobile()&&(S.uiAddButton(e,"devori",(()=>{ATON.Nav.isDevOri()?(ATON.Nav.restorePreviousNavMode(),S.uiSwitchButton("devori",!1)):(ATON.Nav.setDeviceOrientationControl(),S.uiSwitchButton("devori",!0))}),"Device-orientation mode"),ATON.Nav.isDevOri()?S.uiSwitchButton("devori",!0):S.uiSwitchButton("devori",!1))},uiAddButtonNav:e=>{S.uiAddButton(e,"nav",(()=>{S.popupNav()}),"Navigation")},uiAddButtonTalk:e=>{ATON.Utils.isConnectionSecure()&&(S.uiAddButton(e,"talk",(()=>{ATON.MediaRec.isAudioRecording()?(ATON.MediaRec.stopMediaStreaming(),$("#btn-talk").removeClass("atonBTN-rec")):(ATON.MediaRec.startMediaStreaming(),$("#btn-talk").addClass("atonBTN-rec"))}),"Talk ON/OFF"),ATON.MediaRec.isAudioRecording()?$("#btn-talk").addClass("atonBTN-rec"):$("#btn-talk").removeClass("atonBTN-rec"))},uiAddButtonStreamFocus:e=>{S.uiAddButton(e,"focus",(()=>{ATON.VRoadcast._bStreamFocus?(ATON.VRoadcast.setFocusStreaming(!1),$("#btn-focus").removeClass("atonBTN-rec")):(ATON.VRoadcast.setFocusStreaming(!0),$("#btn-focus").addClass("atonBTN-rec"))}),"Focus streaming ON/OFF"),ATON.VRoadcast._bStreamFocus?$("#btn-focus").addClass("atonBTN-rec"):$("#btn-focus").removeClass("atonBTN-rec")},uiAddButtonQR:e=>{S.uiAddButton(e,"qr",S.popupQR,"QR-code")},uiAddButtonScreenshot:e=>{S.uiAddButton(e,"sshot",S.popupScreenShot,"Screenshot")},uiAddButtonInfo:e=>{S.uiAddButton(e,"info",ATON.FE.popupSceneInfo,"Scene information"),$("#btn-info").hide()},uiAddButtonFullScreen:e=>{S.uiAddButton(e,"fullscreen",(()=>{ATON.toggleFullScreen()}),"Fullscreen"),S.uiSwitchButton("fullscreen",ATON.isFullscreen())},uiAddKeywordsArea:(e,t,o,i)=>{let r="";r+="Add keyword: <input id='idKWordInput' list='lkwords' type='text' maxlength='100' size='20'><div class='atonBTN atonBTN-green' id='idKWadd'><img src='"+ATON.FE.PATH_RES_ICONS+"add.png'></div><br>",r+="<div id='idKWords'></div>",$("#"+e).html(r),S.uiAttachInputFilterID("idKWordInput"),$.getJSON(ATON.PATH_RESTAPI+"keywords/",(t=>{let o="<datalist id='lkwords'>";for(let e in t)o+="<option>"+e+"</option>";o+="</datalist>",$("#"+e).append(o)}));let s={},n=e=>{s[e]||(e=e.toLowerCase().trim(),$("#idKWordInput").val(""),s[e]=1,console.log("Added keyword "+e),o&&o(e),$("#idKWords").append("<div class='atonKeyword atonKeywordActivable' id='idkw-"+e+"'>"+e+"</div>"),$("#idkw-"+e).click((()=>{$("#idkw-"+e).remove(),s[e]=void 0,console.log("Removed keyword "+e),i&&i(e)})))};if(t)for(let e in t)n(t[e]);$("#idKWordInput").keypress((function(e){if("13"!=(e.keyCode?e.keyCode:e.which))return;let t=$("#idKWordInput").val().toLowerCase().trim();!t||t.length<3||n(t)})),$("#idKWadd").click((()=>{let e=$("#idKWordInput").val().toLowerCase().trim();!e||e.length<3||n(e)}))},uiAttachCollectionItemsToInput:(e,t)=>{let o="";$("#"+e).attr("list",e+"-list"),$("#"+e).attr("name",e+"-list"),$.getJSON(ATON.PATH_RESTAPI+"c/"+t+"/",(t=>{o+="<datalist id='"+e+"-list'>";for(let e in t){let i=t[e];o+="<option value='"+i+"'>"+i+"</option>"}o+="</datalist>",$("#"+e).html(o)}))},getVRCclassFromID:e=>"atonVRCu"+e%6,_setupVRCevents:()=>{S._bVRCsetup||(ATON.on("VRC_IDassigned",(e=>{$("#btn-vrc").addClass(S.getVRCclassFromID(e)),ATON.SUI.setSelectorColor(ATON.VRoadcast.ucolors[e%6]),S.checkAuth((e=>{void 0!==e.username&&ATON.VRoadcast.setUsername(e.username)}))})),ATON.on("VRC_SceneState",(e=>{let t=ATON.VRoadcast.getNumUsers();t>1?$("#idVRCnumusers").html(t):$("#idVRCnumusers").html(""),console.log("Users: "+t)})),ATON.on("VRC_Disconnected",(()=>{$("#btn-vrc").attr("class","atonBTN"),ATON.SUI.setSelectorColor(ATON.MatHub.colors.defUI),$("#idVRCnumusers").html("")})),S._bVRCsetup=!0)},uiAddButtonVRC:e=>{S.uiAddButton(e,"vrc",(()=>{ATON.VRoadcast.isConnected()?S.popupVRC():ATON.VRoadcast.connect(S._vrcAddr)}),"VRoadcast (collaborative session)"),$("#btn-vrc").append("<span id='idVRCnumusers' class='atonVRCcounter'></span>"),S._setupVRCevents(),void 0!==ATON.VRoadcast.uid?$("#btn-vrc").addClass(S.getVRCclassFromID(ATON.VRoadcast.uid)):$("#btn-vrc").attr("class","atonBTN")},uiAddButtonUser:e=>{S.uiAddButton(e,"user",(()=>{S.popupUser()}),"User"),S.checkAuth((e=>{void 0!==e.username?$("#btn-user").addClass("switchedON"):$("#btn-user").removeClass("switchedON")}))},uiAddButtonEditMode:e=>{S.uiAddButton(e,"edit",(()=>{S.checkAuth((e=>{void 0!==e.username?(ATON.SceneHub._bEdit=!ATON.SceneHub._bEdit,S.uiSwitchButton("edit",ATON.SceneHub._bEdit)):S.popupUser()}))}))},uiAddProfile:(e,t)=>{"function"==typeof t&&(S._uiProfiles[e]=t)},uiLoadProfile:e=>{let t=S._uiProfiles[e];void 0!==t&&(t(),S._uiCurrProfile=e,console.log("Loaded UI Profile: "+S._uiCurrProfile))},attachHandlerToButton:(e,t)=>{void 0!==t&&$("#"+e).click((()=>{t()}))},uiAttachInputFilterID:e=>{$("#"+e).on("keyup change input",(()=>{let t=$("#"+e).val(),o=new RegExp("[^A-Za-z0-9-_]","ig");$("#"+e).val(t.replace(o,""))}))},switchNode:(e,t,o)=>{let i;i=o===ATON.NTYPES.SEM?ATON.getSemanticNode(e):ATON.getSceneNode(e),void 0!==i&&(i.toggle(t),ATON.fireEvent("FE_NodeSwitch",{nid:e,t:o,v:t}))},uiCreateGraph:e=>{let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes);let o="";for(let i in t){let r=t[i].visible?"checked":"";"."!==i&&(o+="<input type='checkbox' "+r+" onchange=\"ATON.FE.switchNode('"+i+"',this.checked,"+e+');">'+i+"<br>")}return o},setupBasicUISounds:()=>{S.auLib={},S.auLib.switch=new Audio(ATON.PATH_RES+"audio/switch.wav"),S.auLib.switch.loop=!1},playAudioFromSemanticNode:e=>{if(void 0===e)return;let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=t.getAudio();void 0!==o&&(void 0===S._auSemNode||null===S._auSemNode?S._auSemNode=new THREE.Audio(ATON.AudioHub._listener):S._auSemNode.stop(),ATON.AudioHub._loader.load(o,(e=>{S._auSemNode.setBuffer(e),S._auSemNode.setLoop(!1),S._auSemNode.play()})))},popupShow:(e,t)=>{if(S._bPopup)return!1;let o="atonPopup ";t&&(o+=t);let i="<div id='idPopupContent' class='"+o+"'>";return i+=e+"</div>",$("#idPopup").html(i),$("#idPopupContent").click((e=>{e.stopPropagation()})),$("#idPopup").fadeIn(S.POPUP_DELAY),S._bPopup=!0,ATON._bListenKeyboardEvents=!1,S.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="blur("+S.popupBlurBG+"px)"),ATON._bPauseQuery=!0,$("#idTopToolbar").hide(),$("#idBottomToolbar").hide(),$("#idBottomRToolbar").hide(),$("#idPoweredBy").hide(),!0},popupClose:e=>{S._bPopup=!1,ATON._bListenKeyboardEvents=!0,S.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="none"),!0===e?$("#idPopup").hide():$("#idPopup").fadeOut(S.POPUP_DELAY),ATON._bPauseQuery=!1,$("#idTopToolbar").show(),$("#idBottomToolbar").show(),$("#idBottomRToolbar").show(),$("#idPoweredBy").show(),ATON.focusOn3DView()},subPopup:e=>{ATON.FE.popupClose(),setTimeout(e,ATON.FE.POPUP_DELAY)},popupQR:()=>{let e="<div class='atonPopupTitle'>Share</div>";if(e+="<div class='atonQRcontainer' id='idQRcode'></div><br><br>",!ATON.FE.popupShow("<div class='atonPopupTitle'>Share</div><div class='atonQRcontainer' id='idQRcode'></div><br><br>"))return;let t=window.location.href;new QRCode(document.getElementById("idQRcode"),t)},popupScreenShot:()=>{let e=ATON.Utils.takeScreenshot(200);S.checkAuth((t=>{let o="<div class='atonPopupTitle'>Screenshot</div>";o+="This is a preview of what your screenshot will look like:<br><br>",o+="<img src='"+e.src+"'><br>",o+="Resolution: <input id='isShotSize' type='number' min='100' max='4000' value='200'>px<br>",o+="<div class='atonBTN atonBTN-green' id='btnScreenShot' style='width:90%'><img src='"+S.PATH_RES_ICONS+"sshot.png'>SHOT</div>",void 0!==t.username&&(o+="<div class='atonBTN atonBTN-green' id='btnSetCover' style='width:90%'>Set as Cover</div>"),ATON.FE.popupShow(o)&&($("#btnScreenShot").click((()=>{ATON.FE.popupClose();let e=parseInt($("#isShotSize").val());ATON.Utils.takeScreenshot(e,"shot.png")})),$("#btnSetCover").click((()=>{ATON.FE.popupClose(),ATON.Utils.postJSON(ATON.PATH_RESTAPI+"cover/scene/",{sid:ATON.SceneHub.currID,img:e.src},(e=>{console.log(e)}))})))}))},popupVRC:()=>{let e="",t=ATON.VRoadcast.getNumUsers();e+=t>1?"<div class='atonPopupTitle'>Collaborative Session ("+t+" users)</div>":"<div class='atonPopupTitle'>Collaborative Session</div>",e+="<input id='idVRCusername' type='text' size='10' placeholder='username...' style='display:none'>",e+="<div id='idVRCusernameBTN' class='atonBTN' style='width:150px; display:none'>"+ATON.VRoadcast._username+"</div>",e+="<div id='idChatBox' style='width:100%; height:150px; text-align:left;' class='scrollableY'></div>",e+="<input id='idVRCmsg' style='width:90%' type='text' placeholder='message...'>",e+="<div class='atonBTN' id='idVRCdisconnect' style='width:90%'>LEAVE</div>",ATON.FE.popupShow(e,"atonPopupLarge")&&(void 0===ATON.VRoadcast._username?($("#idVRCusername").show(),$("#idVRCusernameBTN").hide()):($("#idVRCusername").val(ATON.VRoadcast._username),$("#idVRCusername").hide(),$("#idVRCusernameBTN").show()),void 0!==ATON.VRoadcast.uid&&$("#idVRCusernameBTN").addClass("atonVRCu"+ATON.VRoadcast.uid%6),$("#idChatBox").append(ATON.VRoadcast._elChat),$("#idVRCmsg").keypress((e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCmsg").val();ATON.VRoadcast.setMessage(e),$("#idVRCmsg").val("")}})),$("#idVRCusername").keypress((e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCusername").val();ATON.VRoadcast.setUsername(e),$("#idVRCusername").hide(),$("#idVRCusernameBTN").html(ATON.VRoadcast._username),$("#idVRCusernameBTN").show()}})),$("#idVRCusernameBTN").click((()=>{$("#idVRCusername").show(),$("#idVRCusernameBTN").hide()})),$("#idVRCdisconnect").click((()=>{ATON.VRoadcast.disconnect(),ATON.FE.popupClose()})))},checkAuth:e=>{ATON.Utils.checkAuth((t=>{S._userAuth=t,void 0!==t.username?($("#btn-user").addClass("switchedON"),void 0===ATON.VRoadcast._username&&ATON.VRoadcast.setUsername(t.username)):$("#btn-user").removeClass("switchedON"),e&&e(t)}))},popupUser:()=>{S.checkAuth((e=>{if(void 0!==e.username){let t="<img src='"+S.PATH_RES_ICONS+"user.png'><br>";if(t+="<b>'"+e.username+"'</b><br><br>",Object.keys(S._uiProfiles)){t+="UI Profile:<br><div class='select' style='width:150px;'><select id='idUIProfiles'>";for(let e in S._uiProfiles)t+="<option value='"+e+"'>"+e+"</option>";t+="</select><div class='selectArrow'></div></div><br><br>"}if(t+="<div class='atonBTN atonBTN-red' id='idLogoutBTN' style='width:90%'>LOGOUT</div>",!ATON.FE.popupShow(t))return;S._uiCurrProfile&&(console.log(S._uiCurrProfile),$("#idUIProfiles").val(S._uiCurrProfile)),$("#idLogoutBTN").click((()=>{$.get(ATON.PATH_RESTAPI+"logout",(e=>{console.log(e),ATON.SceneHub.setEditMode(!1),ATON.fireEvent("Logout"),$("#btn-user").removeClass("switchedON")})),ATON.FE.popupClose()})),$("#idSHUscenes").click((()=>{ATON.Utils.goToURL("/shu/scenes/")})),$("#idSHUuser").click((()=>{ATON.Utils.goToURL("/shu/auth/")})),$("#idUIProfiles").on("change",(()=>{let e=$("#idUIProfiles").val();S.uiLoadProfile(e),ATON.FE.popupClose()}))}else{let e="<img src='"+S.PATH_RES_ICONS+"user.png'><br>";if(e+="username:<input id='idUsername' type='text' maxlength='15' size='15' ><br>",e+="password:<input id='idPassword' type='password' maxlength='15' size='15' ><br>",e+="<div class='atonBTN atonBTN-green' id='idLoginBTN' style='width:90%'>LOGIN</div>",!ATON.FE.popupShow(e))return;$("#idLoginBTN").click((()=>{let e=JSON.stringify({username:$("#idUsername").val(),password:$("#idPassword").val()});$.ajax({url:ATON.PATH_RESTAPI+"login",type:"POST",data:e,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{console.log(e),e&&(ATON.fireEvent("Login",e),$("#btn-user").addClass("switchedON"),ATON.FE.popupClose())}}).fail((e=>{$("#idLoginBTN").html("LOGIN FAILED"),$("#idLoginBTN").attr("class","atonBTN atonBTN-red")}))}))}}))},popupSceneInfo:()=>{let e=ATON.SceneHub.getTitle();void 0===e&&(e=ATON.SceneHub.currID);let t=ATON.SceneHub.getDescription(),o="<div class='atonPopupTitle'>"+e+"</div>";t&&(o+="<div class='atonPopupDescriptionContainer'>"+JSON.parse(t)+"</div>"),o+="<div class='atonBTN atonBTN-green' id='btnOK' style='width:90%'>OK</div>",ATON.FE.popupShow(o)&&$("#btnOK").click((()=>{ATON.FE.popupClose()}))},computeSelectorRanges:()=>{let e=ATON.getRootScene().getBound().radius;e<=0||(S._selRanges[0]=.001*e,S._selRefRadius=.02*e,S._selRanges[1]=.5*e)},popupSelector:()=>{let e="<div class='atonPopupTitle'>3D Selector</div>",t=ATON.SUI.getSelectorRadius(),o=ATON.Utils.getHumanReadableDistance(t);S.computeSelectorRanges(),e+="Radius (<span id='idSelRadTxt'>"+o+"</span>):<br>",e+="<input id='idSelRad' type='range' min='"+S._selRanges[0]+"' max='"+S._selRanges[1]+"' step='"+S._selRanges[0]+"' style='width:90%'>",ATON.FE.popupShow(e,"atonPopupLarge")&&($("#idSelRad").val(t),$("#idSelRad").on("input change",(()=>{let e=parseFloat($("#idSelRad").val());ATON.SUI.setSelectorRadius(e),$("#idSelRadTxt").html(ATON.Utils.getHumanReadableDistance(e))})))},popupNav:()=>{let e="<div class='atonPopupTitle'>Navigation</div>";e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMfp'></div>",e+="<div style='text-align:left'>Switch between first-person and orbit navigation mode</div>",e+="</div>",ATON.Utils.isConnectionSecure()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMvr'></div>",e+="<div style='text-align:left'>Immersive VR mode</div>",e+="</div>",ATON.Utils.isMobile()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMdevori'></div>",e+="<div style='text-align:left'>Enable or disable device-orientation mode</div>",e+="</div>")),S.popupShow(e)&&(S.uiAddButtonFirstPerson("idNMfp"),S.uiAddButtonDeviceOrientation("idNMdevori"),S.uiAddButtonVR("idNMvr"))}};const P=S;let E={auType:"audio/wav",auExt:".wav",auBitsPerSecond:9e3,auStreamInterval:1e3,auMinVol:1,init:()=>{E._bAudioRecording=!1,E._bStreaming=!1,E.recorder=void 0},realizeAudioRecorder:e=>{if(void 0!==E.recorder)E.recorder.reset(),e&&e();else{if(!ATON.Utils.isConnectionSecure())return;if(!navigator.mediaDevices)return;void 0===E._ds&&(E._ds=setInterval(E._streamChunk,E.auStreamInterval)),navigator.mediaDevices.getUserMedia({video:!1,audio:!0,channelCount:1,echoCancellation:!0}).then((async function(t){E.recorder=RecordRTC(t,{type:"audio",mimeType:E.auType,bitsPerSecond:E.auBitsPerSecond,audioBitsPerSecond:E.auBitsPerSecond,sampleRate:22050,desiredSampRate:22050,disableLogs:!0,numberOfAudioChannels:1}),e&&e()}))}},isAudioRecording:()=>E._bAudioRecording,_stopRecAndSend:e=>{void 0!==E.recorder?E.recorder.stopRecording((()=>{E.recorder.getDataURL((t=>{ATON.VRoadcast.socket&&void 0!==ATON.VRoadcast.uid?(ATON.VRoadcast.socket.compress(!1).emit("UTALK",{audio:t,uid:ATON.VRoadcast.uid}),e&&e()):e&&e()}))})):e&&e()},_onAuBlob:e=>{e&&ATON.VRoadcast.socket&&ATON.VRoadcast.socket.emit("UTALK",{blob:e,uid:ATON.VRoadcast.uid,vol:E._auAVGvolume})},startRecording:()=>{E.realizeAudioRecorder((()=>{E.recorder&&(E._bAudioRecording||(console.log("Recording..."),E.recorder.startRecording(),E._bAudioRecording=!0))}))},stopRecording:()=>{E.recorder&&E.recorder.stopRecording((()=>{let e=E.recorder.getBlob();console.log("Stop recording.");let t=new FileReader;t.readAsDataURL(e),t.onloadend=()=>{let e=t.result;ATON.fireEvent("AudioRecordCompleted",e)},E._bAudioRecording=!1}))},startOrStopRecording:()=>{E._bAudioRecording?E.stopRecording():E.startRecording()},_streamChunk:()=>{E.recorder&&E._bStreaming&&E._stopRecAndSend((()=>{E.recorder.startRecording()}))},startMediaStreaming:()=>{E.realizeAudioRecorder((()=>{E.recorder&&(E._bAudioRecording||(console.log("Start MediaStreaming"),E.recorder.startRecording(),E._bAudioRecording=!0,E._bStreaming=!0))}))},stopMediaStreaming:()=>{E.recorder&&E._bAudioRecording&&(console.log("Stop MediaStreaming"),E._stopRecAndSend((()=>{})),E._bStreaming=!1,E._bAudioRecording=!1)},startOrStopMediaStreaming:()=>{E._bAudioRecording?E.stopMediaStreaming():E.startMediaStreaming()}};const R=E;let f={EARTH_R_KM:6371};f.EARTH_D_KM=2*f.EARTH_R_KM,f.init=()=>{f._bActive=!1,f._wpid=void 0,f._currPos=new THREE.Vector2,f._POIs=[],f._currPOI=void 0,f._closestPOI=void 0,f._maxError=40},f.enableTracking=()=>{f._bActive||ATON.Utils.isConnectionSecure()&&navigator.geolocation&&(f._wpid=navigator.geolocation.watchPosition(f._onPosition,f._onError,{enableHighAccuracy:!0}),f._bActive=!0)},f.disableTracking=()=>{f._bActive&&(navigator.geolocation.clearWatch(f._wpid),f._bActive=!1)},f.setMaxError=e=>{e>0&&(f._maxError=e)},f._onError=()=>{console.log("Geolocation error")},f._onPosition=e=>{if(!f._bActive)return;if(!e.coords)return;let t=e.coords.accuracy;t&&t>f._maxError||(f._currPos.x=e.coords.latitude,f._currPos.y=e.coords.longitude,ATON.fireEvent("GeoLocation",e),f._handlePOIs())},f._handlePOIs=()=>{let e=f._POIs.length;if(!(e<=0)){f._closestPOIdist=void 0,f._closestPOI=void 0;for(let t=0;t<e;t++){let e=f._POIs[t],o=f.distance(f._currPos,e.pos);(void 0===f._closestPOIdist||o<f._closestPOIdist)&&(f._closestPOIdist=o,f._closestPOI=t),o<=e.radius?(f._currPOI!==t&&ATON.fireEvent("EnterPOI",{id:t,distance:o}),f._currPOI=t):(void 0!==f._currPOI&&ATON.fireEvent("LeavePOI",{id:f._currPOI,distance:o}),f._currPOI=void 0)}}},f.getCurrentLocation=()=>{if(f._bActive)return f._currPos},f.locationFromLatLon=(e,t)=>new THREE.Vector2(e,t),f.distance_orig=(e,t)=>{let o=ATON.DEG2RAD*(t.x-e.x),i=ATON.DEG2RAD*(t.y-e.y),r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(ATON.DEG2RAD*e.x)*Math.cos(ATON.DEG2RAD*t.x)*Math.sin(i/2)*Math.sin(i/2),s=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return f.EARTH_R_KM*s*1e3},f.distance=(e,t)=>{let o=.5-Math.cos((t.x-e.x)*ATON.DEG2RAD)/2+Math.cos(e.x*ATON.DEG2RAD)*Math.cos(t.x*ATON.DEG2RAD)*(1-Math.cos((t.y-e.y)*ATON.DEG2RAD))/2;return f.EARTH_D_KM*Math.asin(Math.sqrt(o))*1e3},f.addPOI=(e,t)=>{let o={};return o.pos=new THREE.Vector2(e.x,e.y),o.radius=t,f._POIs.push(o),f._bActive||f.enableTracking(),f._handlePOIs(),f._POIs.length-1},f.getPOIbyIndex=e=>f._POIs[e],f.getClosestPOI=()=>f._closestPOI,f.getClosestPOIdistance=()=>f._closestPOIdist;const b=f;let w={init:()=>{w._appid=$("meta[name='aton\\:appid']").attr("content"),w._appdata={}},_sendDataPatch:(e,t,o)=>new Promise(((i,r)=>{if(void 0===e)return void r("No storage ID specified");if(e.length<3)return void r("Storage ID too short");if(void 0===t)return void r("No storage patch");if(void 0===w._appid)return void r("No app-ID");void 0===o&&(o=ATON.PATCH_ADD);let s={};s.wappid=w._appid,s.fid=e,s.data=t,s.mode=o===ATON.PATCH_DEL?"DEL":"ADD";let n=JSON.stringify(s);$.ajax({url:ATON.PATH_RESTAPI+"patch/wapp",type:"POST",data:n,contentType:"application/json; charset=utf-8",dataType:"json",success:t=>{void 0!==t?(w._appdata[e]=t,i(t)):r("Error writing on server")}})})),getAppID:()=>w._appid,addToStorage:(e,t)=>w._sendDataPatch(e,t,ATON.PATCH_ADD),deleteFromStorage:(e,t)=>w._sendDataPatch(e,t,ATON.PATCH_DEL),getStorage:e=>new Promise(((t,o)=>{void 0!==w._appid?void 0!==e?$.getJSON(ATON.PATH_WAPPS+w._appid+"/data/"+e+".json",(o=>{console.log(o),w._appdata[e]=o,t(o)})):o("No storage ID specified"):o()}))};const M=w;let y={PASS_BASE:0,PASS_AA:1,PASS_AO:2,PASS_SSR:3,PASS_BLOOM:4,PASS_DOF:5,PASS_GAMMA:6,init:()=>{if(void 0===ATON._renderer)return;y.composer=new THREE.EffectComposer(ATON._renderer),y.passes=[],ATON._renderer.autoClear=!1;let e=window.innerWidth*ATON._stdpxd,t=window.innerHeight*ATON._stdpxd;y.passes[y.PASS_BASE]=new THREE.RenderPass(ATON._mainRoot,ATON.Nav._camera),y.composer.addPass(y.passes[y.PASS_BASE]),y.passes[y.PASS_AO]=new THREE.SAOPass(ATON._mainRoot,ATON.Nav._camera,!1,!0),y.passes[y.PASS_AO].params.saoBias=1,y.passes[y.PASS_AO].params.saoScale=100,y.passes[y.PASS_AO].params.saoIntensity=.2,y.passes[y.PASS_BLOOM]=new THREE.UnrealBloomPass(new THREE.Vector2(e,t),1.5,.4,.85),y.passes[y.PASS_BLOOM].threshold=.9,y.passes[y.PASS_BLOOM].strength=1,y.passes[y.PASS_BLOOM].radius=0,y.passes[y.PASS_DOF]=new THREE.BokehPass(ATON._mainRoot,ATON.Nav._camera,{focus:5,aperture:.001,maxblur:.01,width:e,height:t}),y.passes[y.PASS_GAMMA]=new THREE.ShaderPass(THREE.GammaCorrectionShader),y.passes[y.PASS_AA]=new THREE.ShaderPass(THREE.FXAAShader),y.passes[y.PASS_AA].material.uniforms.resolution.value.set(1/e,1/t),y.composer.addPass(y.passes[y.PASS_AO]),y.composer.addPass(y.passes[y.PASS_BLOOM]),y.composer.addPass(y.passes[y.PASS_GAMMA]),y.composer.addPass(y.passes[y.PASS_AA]),y.composer.addPass(y.passes[y.PASS_DOF]),y.togglePass(y.PASS_AO,!1),y.togglePass(y.PASS_BLOOM,!1),y.togglePass(y.PASS_DOF,!1),console.log(y.composer)},togglePass:(e,t)=>{void 0!==y.composer&&(ATON.device.lowGPU||void 0!==y.passes[e]&&(y.passes[e].enabled=void 0===t?!y.passes[e].enabled:t))},isPassEnabled:e=>void 0!==y.composer&&(void 0!==y.passes[e]&&y.passes[e].enabled),setAOintensity:e=>{void 0!==y.composer&&void 0!==y.passes[y.PASS_AO]&&(y.passes[y.PASS_AO].params.saoIntensity=e)},getAOintensity:()=>void 0===y.composer||void 0===y.passes[y.PASS_AO]?0:y.passes[y.PASS_AO].params.saoIntensity,setBloomStrength:e=>{void 0!==y.composer&&void 0!==y.passes[y.PASS_BLOOM]&&(y.passes[y.PASS_BLOOM].strength=e)},getBloomStrength:()=>void 0===y.composer||void 0===y.passes[y.PASS_BLOOM]?0:y.passes[y.PASS_BLOOM].strength,setBloomThreshold:e=>{void 0!==y.composer&&void 0!==y.passes[y.PASS_BLOOM]&&(y.passes[y.PASS_BLOOM].threshold=e)},getBloomThreshold:()=>void 0===y.composer||void 0===y.passes[y.PASS_BLOOM]?0:y.passes[y.PASS_BLOOM].threshold,setDOFfocus:e=>{if(void 0===y.composer)return;if(void 0===y.passes[y.PASS_DOF])return;let t=y.passes[y.PASS_DOF].uniforms;void 0!==t&&(t.focus.value=e)},getDOFfocus:()=>{if(void 0===y.composer)return 0;if(void 0===y.passes[y.PASS_DOF])return 0;let e=y.passes[y.PASS_DOF].uniforms;return void 0===e?0:e.focus.value},setDOFaperture:e=>{if(void 0===y.composer)return;if(void 0===y.passes[y.PASS_DOF])return;let t=y.passes[y.PASS_DOF].uniforms;void 0!==t&&(t.aperture.value=e)}};const C=y;let H={};window.ATON=H,H.Node=t,H.POV=class{constructor(e){this.pos=new THREE.Vector3(1,0,0),this.target=new THREE.Vector3(0,0,0),this.up=ATON.STD_UPVECTOR,this.fov=void 0,this.nextPOV=void 0,this.prevPOV=void 0,this.as(e)}as(e){if(void 0!==e)return ATON.Nav.povlist[e]=this,this.id=e,this}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setTarget(e,t,o){return e instanceof THREE.Vector3?this.target.copy(e):this.target.set(e,t,o),this}setFOV(e){return this.fov=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setNextPOV(e){if(e)return this.nextPOV=e,this}setPrevPOV(e){if(e)return this.prevPOV=e,this}},H.LightProbe=class{constructor(e,t,o){this.pos=new THREE.Vector3(0,0,0),this._res=void 0!==e?e:64,this._near=void 0!==t?t:1,this._far=void 0!==o?o:ATON.Nav.STD_FAR,this._envtex=void 0,this._prevCCtarget=void 0}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setNear(e){return this._near=e,this}setFar(e){return this._far=e,this}update(){this._envtex&&this._envtex.dispose(),this._prevCCtarget&&this._prevCCtarget.dispose();let e=new THREE.WebGLCubeRenderTarget(this._res,{format:THREE.RGBEFormat,generateMipmaps:!0,minFilter:THREE.LinearMipmapLinearFilter,encoding:THREE.sRGBEncoding}),t=new THREE.CubeCamera(this._near,this._far,e);return t.position.copy(this.pos),t.update(ATON._renderer,ATON._rootVisibleGlobal),this._envtex=e.texture,this._prevCCtarget=e,this}getEnvTex(){return this._envtex}assignToNode(e){}},H.EventHub=i,H.Utils=a,H.SceneHub=l,H.MatHub=s,H.Nav=p,H.AudioHub=u,H.XR=T,H.SUI=m,H.VRoadcast=A,H.SemFactory=g,H.FE=P,H.MediaRec=R,H.GeoLoc=b,H.AppHub=M,H.FX=C,H.STD_UPVECTOR=new THREE.Vector3(0,1,0),H.ROOT_NID=".",H.RAD2DEG=180/Math.PI,H.DEG2RAD=Math.PI/180,H.PATCH_ADD=0,H.PATCH_DEL=1,H.NTYPES={},H.NTYPES.SCENE=3,H.NTYPES.SEM=4,H.NTYPES.UI=5,H.PATH_RESTAPI=window.location.origin+"/api/",H.PATH_RESTAPI_SCENE=H.PATH_RESTAPI+"scene/",H.PATH_WAPPS=window.location.origin+"/a/",H.PATH_MODS=window.location.origin+"/mods/",H.PATH_DRACO_LIB=window.location.origin+"/dist/draco/",H.PATH_BASIS_LIB=window.location.origin+"/dist/basis/",H.PATH_IFC_LIB=window.location.origin+"/dist/ifc/",H.PATH_COLLECTION=window.location.origin+"/collections/",H.PATH_SCENES=window.location.origin+"/scenes/",H.PATH_RES=window.location.origin+"/res/",H.PATH_FE=window.location.origin+"/fe/",H.SHADOWS_NEAR=.1,H.SHADOWS_FAR=50,H.SHADOWS_SIZE=15,H.SHADOWS_RES=1024,H.AMB_L=.1,H.setPathCollection=e=>{H.PATH_COLLECTION=e},H.setPathScenes=e=>{H.PATH_SCENES=e},H._onUserInteraction=()=>{H._elPanoVideo&&!H._vpanoPlaying&&H._elPanoVideo.play(),"suspended"===H.AudioHub._listener.context.state&&H.AudioHub._listener.context.resume()},H._setupBaseListeners=()=>{let e=H._renderer.domElement;window.addEventListener("resize",H._onResize,!1),window.onorientationchange=H._readDeviceOrientationMode,screenfull.isEnabled&&screenfull.on("change",(()=>{H._bFS=screenfull.isFullscreen,H.fireEvent("Fullscreen",H._bFS),H._bFS?console.log("Now fullscreen"):console.log("Exit fullscreen")})),e.addEventListener("mousemove",H._updateScreenMove,!1),e.addEventListener("mousedown",(e=>{1===e.button&&H.fireEvent("MouseMidButton"),2===e.button&&H.fireEvent("MouseRightButton")})),e.addEventListener("wheel",H._onMouseWheel,!1),H._bPointerDown=!1,window.addEventListener("pointerdown",(e=>{H._bPointerDown=!0,H._onUserInteraction()})),window.addEventListener("pointerup",(e=>{H._bPointerDown=!1})),window.addEventListener("pointermove",(e=>{H._bPointerDown&&(H._updateScreenMove(e),H._handleQueries())})),window.addEventListener("touchstart",(e=>{H._bPointerDown=!0,H._onUserInteraction()})),window.addEventListener("touchend",(e=>{H._bPointerDown=!1})),window.addEventListener("touchmove",(e=>{H._bPointerDown&&(H._updateScreenMove(e.touches[0]),H._handleQueries())})),Hammer(e).on("doubletap",(e=>{H._bPointerDown=!1,H.fireEvent("DoubleTap",e.srcEvent)})),Hammer(e).on("tap",(e=>{if(H._bPointerDown=!1,H._onUserInteraction(),H._updateScreenMove(e.srcEvent),H._handleQueries(),H.fireEvent("Tap",e.srcEvent),void 0===H._hoveredUI)return;let t=H.getUINode(H._hoveredUI);t&&t.onSelect&&t.onSelect()})),H.on("DoubleTap",(e=>{H.defaultDoubleTapFromScreenCoords(e)})),H._kModShift=!1,H._kModCtrl=!1,H._bListenKeyboardEvents=!0,window.addEventListener("keydown",(e=>{H._onUserInteraction(),"Shift"===e.key&&(H._kModShift=!0),"Control"===e.key&&(H._kModCtrl=!0),H._bListenKeyboardEvents&&H.fireEvent("KeyPress",e.key)}),!1),window.addEventListener("keyup",(e=>{"Shift"===e.key&&(H._kModShift=!1),"Control"===e.key&&(H._kModCtrl=!1),H._bListenKeyboardEvents&&H.fireEvent("KeyUp",e.key)}),!1),H.on("KeyPress",(e=>{if("+"===e){let e=H.Nav.getFOV()+1;H.Nav.setFOV(e)}if("-"===e){let e=H.Nav.getFOV()-1;H.Nav.setFOV(e)}if("PageUp"===e){let e=H.SUI.mainSelector.scale.x+.02;H.SUI.setSelectorRadius(e)}if("PageDown"===e){let e=H.SUI.mainSelector.scale.x-.02;e=Math.max(e,.01),H.SUI.setSelectorRadius(e)}}))},H._onResize=()=>{if(H.Nav._camera.aspect=window.innerWidth/window.innerHeight,H.Nav._camera.updateProjectionMatrix(),H._renderer.setSize(window.innerWidth,window.innerHeight),H.FX.composer){H.FX.composer.setSize(window.innerWidth,window.innerHeight);let e=H.FX.passes[H.FX.PASS_AA].material.uniforms;e&&e.resolution.value.set(1/window.innerWidth,1/window.innerHeight)}console.log("onResize")},H._onMouseWheel=e=>{e.preventDefault(),H.fireEvent("MouseWheel",e.deltaY)},H.focusOn3DView=()=>{H._renderer.domElement.focus()},H._SUIactivation=()=>{const e=H.getUINode(H._hoveredUI);return void 0!==e&&void 0!==e.onSelect&&(e.onSelect(),!0)},H._stdActivation=()=>{if(H._SUIactivation())return;if(!H.Nav._bControl)return;if(H.XR._bPresenting)return"immersive-vr"===T._sessionType&&T.teleportOnQueriedPoint(),void H.FE.playAudioFromSemanticNode(H._hoveredSemNode);if(H.Nav.isFirstPerson()||H.Nav.isDevOri()){if(H.Nav.currentQueryValidForLocomotion()){let e=H._queryDataScene.p,t=H.Nav._vDir,o=new THREE.Vector3(e.x,e.y+H.userHeight,e.z),i=new THREE.Vector3(o.x+t.x,o.y+t.y,o.z+t.z),r=(new H.POV).setPosition(o).setTarget(i).setFOV(H.Nav._currPOV.fov);H.Nav.requestPOV(r,.5)}return}let e=H.getSemanticNode(H._hoveredSemNode);H._queryDataSem&&e?H.Nav.requestPOVbyNode(e,.5):H._queryDataScene&&H.Nav.requestRetarget(H._queryDataScene.p,void 0,.5)},H.defaultDoubleTapFromScreenCoords=e=>{H._updateScreenMove(e),H._handleQueryScene(),H._stdActivation()},H.isFullscreen=()=>H._bFS,H.toggleFullScreen=()=>{screenfull.toggle()},H.realize=()=>{console.log("Initialize ATON..."),H.Utils.init(),H.Utils.profileDevice(),H._clock=new THREE.Clock(!0),H._bFS=!1,H._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,powerPreference:"high-performance"}),H._renderer.setSize(window.innerWidth,window.innerHeight),H.Utils.profileRenderingCapabilities(),H._stdpxd=1,H._renderer.setPixelRatio(H._stdpxd),H._fps=60,H._dt=.01,H._dtAccum=0,H._avgFPScount=0,H._avgFPSaccum=0,H._avgFPS=60,H._bDynamicDensity=!1,H._dRenderBudgetMinFPS=25,H._dRenderBudgetMaxFPS=55,H._aniMixers=[],H._renderer.outputEncoding=THREE.sRGBEncoding,H._renderer.toneMapping=THREE.LinearToneMapping,H._renderer.toneMappingExposure=1,H._renderer.setAnimationLoop(H._onFrame),H._maxAnisotropy=H._renderer.capabilities.getMaxAnisotropy(),THREE.Cache.enabled=!0,H.userHeight=1.7,document.body.appendChild(H._renderer.domElement);let e=H._renderer.domElement;e.style.outline="none",e.style.border="none",H._vpanoPlaying=!1,H._bUserInts=0,H.EventHub.init(),H.MatHub.init(),H._assetsManager={},H._aLoader=new THREE.GLTFLoader,H._numReqLoad=0,H._dracoLoader=new THREE.DRACOLoader,H._dracoLoader.setDecoderConfig({type:"wasm"}),H._dracoLoader.setDecoderPath(H.PATH_DRACO_LIB),H._dracoLoader.setWorkerLimit(2),H._dracoLoader.preload(),H._aLoader.setDRACOLoader(H._dracoLoader),H._ccModels=[],H._updRoutines=[],H._lps=[],H._bAutoLP=!1,H._envMapInt=1,H._bShadowsFixedBound=!1,H._shadowsFixedBoundCenter=void 0,H._shadowsNear=H.SHADOWS_NEAR,H._shadowsFar=H.SHADOWS_FAR,H._shadowsSize=H.SHADOWS_SIZE,H._shadowsRes=H.SHADOWS_RES,H.initGraphs(),H.SceneHub.init(),H._tsets=[],H.AudioHub.init(),H.Nav.init(),H.XR.init(),H.SUI.init(),H.VRoadcast.init(),H.MediaRec.init(),H.SemFactory.init(),H.AppHub.init(),H.GeoLoc.init(),H.device.lowGPU||H.FX.init(),H._queryDataScene=void 0,H._queryDataSem=void 0,H._queryDataUI=void 0,H._hoveredSemNode=void 0,H._hoveredUI=void 0,H._bQuerySemOcclusion=!0,H._bQueryNormals=!0,H._bPauseQuery=!1,H._bCenteredQuery=!1,H._bqScene=!1,H._bqSem=!1,H._tgiDur=void 0,H._tgiPer=void 0,H._tHover=void 0,H._bMainPanoInfinite=!0,H._matMainPano=void 0,H._mMainPano=void 0,H._screenPointerCoords=new THREE.Vector2(0,0),H._rcScene=new THREE.Raycaster,H._rcScene.layers.set(H.NTYPES.SCENE),H._rcSemantics=new THREE.Raycaster,H._rcSemantics.layers.set(H.NTYPES.SEM),H._rcUI=new THREE.Raycaster,H._rcUI.layers.set(H.NTYPES.UI),H._registerRCS(),H._setupBaseListeners(),H.device.isMobile&&H._readDeviceOrientationMode(),H._wappID=void 0,H._extAPItokens={},H.focusOn3DView()},H.setTimedGazeDuration=e=>{H._tgiDur=e},H.getTimedGazeProgress=()=>{if(void 0!==H._tgiDur)return H._tgiPer},H.getElapsedTime=()=>H._clock.elapsedTime,H.renderPause=()=>{H._renderer.setAnimationLoop(void 0)},H.renderResume=()=>{H._renderer.setAnimationLoop(H._onFrame)},H._setupLoadManager=()=>{H._loadManager=new THREE.LoadingManager,H._loadManager.onStart=(e,t,o)=>{console.log("Started loading file: "+e+".\nLoaded "+t+" of "+o+" files."),H.fireEvent("NodeRequestFired",e)},H._loadManager.onLoad=()=>{console.log("Loading complete!"),H.fireEvent("AllNodeRequestsCompleted")},H._loadManager.onProgress=(e,t,o)=>{},H._loadManager.onError=e=>{console.log("There was an error loading "+e)}},H.setDefaultPixelDensity=e=>{H._stdpxd=e,H._renderer.setPixelRatio(e),H.FX.composer&&H.FX.composer.setPixelRatio(e),void 0!==H._renderer.xr&&(H.device.isMobile?H._renderer.xr.setFramebufferScaleFactor(H._stdpxd*H.XR.MOBILE_DENSITY_F):H._renderer.xr.setFramebufferScaleFactor(H._stdpxd))},H.resetPixelDensity=()=>{H._renderer.setPixelRatio(H._stdpxd)},H._readDeviceOrientationMode=()=>{90===Math.abs(window.orientation)?(console.log("Landscape Mode"),H.fireEvent("MobileLandscapeMode")):(console.log("Portrait Mode"),H.fireEvent("MobilePortraitMode")),setTimeout(H._onResize,500)},H.snodes={},H.semnodes={},H.uinodes={},H.createSceneNode=e=>new H.Node(e,H.NTYPES.SCENE),H.getSceneNode=e=>{if(void 0!==e)return H.snodes[e]},H.getOrCreateSceneNode=e=>{let t=H.getSceneNode(e);return void 0!==t?t:H.createSceneNode(e)},H.getRootScene=()=>H._rootVisible,H.createSemanticNode=e=>new H.Node(e,H.NTYPES.SEM),H.getSemanticNode=e=>{if(void 0!==e)return H.semnodes[e]},H.getOrCreateSemanticNode=e=>{let t=H.getSemanticNode(e);return void 0!==t?t:H.createSemanticNode(e)},H.getRootSemantics=()=>H._rootSem,H.createUINode=e=>new H.Node(e,H.NTYPES.UI),H.getUINode=e=>{if(void 0!==e)return H.uinodes[e]},H.getRootUI=()=>H._rootUI,H._assetReqNew=e=>{H._numReqLoad++,H.fireEvent("NodeRequestFired",e)},H._assetReqComplete=e=>{H.fireEvent("NodeRequestCompleted",e),H._numReqLoad--,H._numReqLoad<=0&&H._onAllReqsCompleted()},H._onAllReqsCompleted=()=>{let e=H._rootVisible.getBound().center,t=H._rootVisible.getBound().radius;H._renderer.shadowMap.enabled&&(H._rootVisible.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),H.adjustShadowsParamsFromSceneBounds(),H._bShadowsFixedBound&&H.updateDirShadows()),H._bAutoLP&&(void 0===H._lps[0]?H.addLightProbe((new H.LightProbe).setPosition(e).setNear(t)):H._lps[0].setPosition(e.x,e.y,e.z).setNear(t),console.log("Auto LP")),H.FX.composer&&H.FX.setDOFaperture(1/(30*t)),e&&H._mMainPano&&H._mMainPano.position.copy(e),H.getRootScene().assignLightProbesByProximity(),H.fireEvent("AllNodeRequestsCompleted"),H._postAllReqsCompleted(),setTimeout((()=>{H.updateLightProbes(),H._renderer.shadowMap.enabled&&H._bShadowsFixedBound&&0===H._aniMixers.length&&(H._dMainL.shadow.autoUpdate=!1,console.log("Lazy shadows"))}),1e3)},H._postAllReqsCompleted=e=>{void 0===e&&(e=H._rootVisible);for(let t in e.children){let o=e.children[t];o&&o.toggle&&(H._postAllReqsCompleted(o),o.toggle(o.visible))}},H.initGraphs=()=>{H._mainRoot=new THREE.Scene,H._mainRoot.background=new THREE.Color(.7,.7,.7),H._rootVisibleGlobal=new THREE.Group,H._mainRoot.add(H._rootVisibleGlobal),H._rootVisible=H.createSceneNode().setAsRoot(),H._rootVisibleGlobal.add(H._rootVisible),H._rootSem=H.createSemanticNode().setAsRoot(),H._mainRoot.add(H._rootSem),H._rootUI=H.createUINode().setAsRoot(),H._mainRoot.add(H._rootUI),H.ambLight=new THREE.AmbientLight(new THREE.Color(1,1,1)),H._rootVisibleGlobal.add(H.ambLight)},H.setBackgroundColor=e=>{H._mainRoot.background=e},H.setAutoLP=e=>{H._bAutoLP=e},H.setNeutralAmbientLight=e=>{H.ambLight.color=new THREE.Color(e,e,e)},H.addLightProbe=e=>{void 0!==e&&(0===H._lps.length&&H.setNeutralAmbientLight(H.AMB_L),H._lps.push(e),void 0!==H.SUI.gLPIcons&&m.addLPIcon(e))},H.updateLightProbes=()=>{if(0!==H._lps.length){for(let e in H._lps)H._lps[e].update();H._lps[0]&&(H._indLP&&H._mainRoot.remove(H._indLP),H._indLP=THREE.LightProbeGenerator.fromCubeRenderTarget(H._renderer,H._lps[0]._prevCCtarget),H._indLP.intensity=1,H._mainRoot.add(H._indLP)),H._rootVisible.traverse((e=>{let t=e.userData.LP;void 0!==t&&t instanceof H.LightProbe&&(e.material.envMap=t.getEnvTex(),e.material.combine=THREE.AddOperation,e.material.envMapIntensity=H._envMapInt)})),console.log("LPs updated.")}},H.setMainPanorama=e=>{let t;e=H.Utils.resolveCollectionURL(e),void 0===H._mMainPano&&(H._gMainPano=new THREE.SphereBufferGeometry(1,60,60),H._gMainPano.castShadow=!1,H._gMainPano.receiveShadow=!1,H._mMainPano=new THREE.Mesh(H._gMainPano,H._matMainPano),H._mMainPano.frustumCulled=!1,H._mMainPano.renderOrder=-100,H.setMainPanoramaRadius(.8*H.Nav.STD_FAR)),H.Utils.isVideo(e)?(void 0===H._elPanoVideo&&(H._elPanoVideo=document.createElement("video"),H._elPanoVideo.id="idPanoVideo",H._elPanoVideo.innerHTML="<source src='"+e+"'>",H._elPanoVideo.crossOrigin="anonymous",H._elPanoVideo.loop=!0,H._elPanoVideo.playsinline=!0,H._elPanoVideo.style.cssText="display:none;",H._elPanoVideo.autoplay=!0,H._elPanoVideo.onplaying=()=>{console.log("VideoPano playing"),H._vpanoPlaying=!0}),t=new THREE.VideoTexture(H._elPanoVideo),t.encoding=THREE.sRGBEncoding,H._realizeOrUpdateMainPano(t)):H.Utils.textureLoader.load(e,(e=>{e.encoding=THREE.sRGBEncoding,e.generateMipmaps=!0,H._realizeOrUpdateMainPano(e)}))},H._realizeOrUpdateMainPano=e=>{if(void 0!==H._matMainPano)return H._matMainPano.map=e,void H.updateLightProbes();H._matMainPano=new THREE.MeshBasicMaterial({map:e,depthTest:!1,depthWrite:!1}),H._mMainPano.material=H._matMainPano,H._bMainPanoInfinite&&(H._mMainPano.onAfterRender=()=>{H.Nav._currPOV&&H._mMainPano.position.copy(H.Nav._currPOV.pos)}),H._rootVisibleGlobal.add(H._mMainPano),H.updateLightProbes()},H.setMainPanoramaRadius=e=>{void 0!==H._gMainPano&&H._gMainPano.scale(-e,e,e)},H.setMainPanoramaRotation=e=>{void 0!==H._mMainPano&&H._mMainPano.rotation.set(0,e,0)},H.setMainPanoramaInfinite=e=>{H._bMainPanoInfinite=e,void 0!==H._mMainPano&&(H._mMainPano.onAfterRender=e?()=>{H.Nav._currPOV&&H._mMainPano.position.copy(H.Nav._currPOV.pos)}:void 0)},H.setMainPanoramaLocation=e=>{H._bMainPanoInfinite||void 0!==H._mMainPano&&H._mMainPano.position.copy(e)},H.setMainLightDirection=e=>{let t=e.clone();t.normalize(),t.x*=.5*H.SHADOWS_FAR,t.y*=.5*H.SHADOWS_FAR,t.z*=.5*H.SHADOWS_FAR,void 0===H._dMainL&&(H._dMainL=new THREE.DirectionalLight(new THREE.Color(1,1,1),1),H._dMainL.castShadow=!1,H._dMainLtgt=new THREE.Object3D,H._rootVisibleGlobal.add(H._dMainLtgt),H._dMainL.target=H._dMainLtgt,H._rootVisibleGlobal.add(H._dMainL),H._dMainLpos=new THREE.Vector3),H._dMainLdir=t,H._dMainL.position.set(-t.x,-t.y,-t.z),H._renderer.shadowMap.enabled&&(H._dMainL.shadow.needsUpdate=!0),H.toggleMainLight(!0)},H.getMainLightDirection=()=>{if(void 0===H._dMainLdir)return;let e=H._dMainLdir.clone();return e.normalize(),e},H.toggleMainLight=e=>{void 0!==H._dMainL&&(H._dMainL.visible=e,e?(H.setNeutralAmbientLight(H.AMB_L),H.updateDirShadows()):H.setNeutralAmbientLight(1))},H.isMainLightEnabled=()=>void 0!==H._dMainL&&!!H._dMainL.visible,H.setExposure=e=>{H._renderer.toneMappingExposure=e},H.getExposure=()=>H._renderer.toneMappingExposure,H.adjustShadowsParamsFromSceneBounds=()=>{if(void 0===H._dMainL)return;let e=H._rootVisible.getBound().radius,t=H._rootVisible.getBound().center;e<=0||e>=H.SHADOWS_SIZE?(H._bShadowsFixedBound=!1,H._shadowsSize=H.SHADOWS_SIZE):(H._bShadowsFixedBound=!0,H._shadowsFixedBoundCenter=t,H._shadowsSize=1.5*e),H._dMainL.shadow.map&&(H._dMainL.shadow.map.dispose(),H._dMainL.shadow.map=null),H._dMainL.shadow.camera.left=-H._shadowsSize,H._dMainL.shadow.camera.right=H._shadowsSize,H._dMainL.shadow.camera.bottom=-H._shadowsSize,H._dMainL.shadow.camera.top=H._shadowsSize,H._dMainL.shadow.mapSize.width=H._shadowsRes,H._dMainL.shadow.mapSize.height=H._shadowsRes,H._dMainL.shadow.camera.near=H._shadowsNear,H._dMainL.shadow.camera.far=H._shadowsFar;let o=-2e-4*e;o<-.001&&(o=-.001),H._dMainL.shadow.bias=o},H.toggleShadows=e=>{void 0!==H._dMainL&&(e?(H._dMainL.castShadow=!0,H._renderer.shadowMap.enabled=!0,H.device.isMobile?H._renderer.shadowMap.type=THREE.PCFShadowMap:H._renderer.shadowMap.type=THREE.PCFSoftShadowMap,H._rootVisible.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),H.adjustShadowsParamsFromSceneBounds(),H.updateDirShadows(),H._dMainL.shadow.needsUpdate=!0,console.log("Shadows ON")):(H._dMainL.castShadow=!1,H._renderer.shadowMap.enabled=!1,console.log("Shadows OFF")))},H.updateDirShadows=()=>{if(void 0===H._dMainLdir)return;let e=H._shadowsFixedBoundCenter;void 0===e?(e=H.Nav.getCurrentEyeLocation(),H._dMainLpos.x=e.x+H.Nav._vDir.x*H._shadowsSize,H._dMainLpos.y=e.y+H.Nav._vDir.y*H._shadowsSize,H._dMainLpos.z=e.z+H.Nav._vDir.z*H._shadowsSize):(H._dMainLpos.x=e.x,H._dMainLpos.y=e.y,H._dMainLpos.z=e.z),H._dMainL.position.set(H._dMainLpos.x-H._dMainLdir.x,H._dMainLpos.y-H._dMainLdir.y,H._dMainLpos.z-H._dMainLdir.z),H._dMainLtgt.position.copy(H._dMainLpos)},H._updateEnvironment=()=>{H._renderer.shadowMap.enabled&&(H._bShadowsFixedBound||H.updateDirShadows())},H.setGlobalAudio=(e,t)=>{void 0!==e&&(void 0===t&&(t=!0),e=H.Utils.resolveCollectionURL(e),void 0===H._auMain||null===H._auMain?H._auMain=new THREE.Audio(H.AudioHub._listener):H._auMain.isPlaying&&H._auMain.stop(),H.AudioHub._loader.load(e,(e=>{H._auMain.setBuffer(e),H._auMain.setLoop(t),H._auMain.play()})))},H._markFPS=()=>{if(H._numReqLoad>0)return;if(H._dt<0)return;const e=1/H._dt;H._avgFPScount+=1,H._dtAccum+=H._dt,H._avgFPSaccum+=e,H._dtAccum<1||(H._fps=H._avgFPSaccum/H._avgFPScount,H._avgFPSaccum=0,H._avgFPScount=0,H._dtAccum=0,H._handleDynamicRenderProfiles())},H.toggleDynamicDensity=e=>{H._bDynamicDensity=e},H.setDynamicRenderingFPS=(e,t)=>{e>=t||(e&&(H._dRenderBudgetMinFPS=e),t&&(H._dRenderBudgetMaxFPS=t))},H._handleDynamicRenderProfiles=()=>{let e=H._renderer.getPixelRatio();H._fps<H._dRenderBudgetMinFPS&&(H._bDynamicDensity&&(e*=.8,e>=.2&&(H._renderer.setPixelRatio(e),H.FX.composer&&H.FX.composer.setPixelRatio(e),console.log(e))),H.fireEvent("RequestLowerRender")),H._fps>H._dRenderBudgetMaxFPS&&(H._bDynamicDensity&&(e*=1.25,e<=H._stdpxd&&(H._renderer.setPixelRatio(e),H.FX.composer&&H.FX.composer.setPixelRatio(e),console.log(e))),H.fireEvent("RequestHigherRender"))},H._onFrame=()=>{H._dt=H._clock.getDelta(),H._markFPS(),H.XR._bPresenting?H.XR.update():H.Nav._controls.update(H._dt),H._handleQueries(),H.Nav.update(),H.VRoadcast.update(),H.SUI.update(),H.MatHub.update(),H._updateEnvironment(),H._updateAniMixers(),H._updateRoutines(),H._updateTSets(),!H.FX.composer||H.XR._bPresenting?H._renderer.render(H._mainRoot,H.Nav._camera):H.FX.composer.render()},H.addUpdateRoutine=e=>{void 0!==e&&H._updRoutines.push(e)},H.deleteAllUpdateRoutines=()=>{H._updRoutines=[]},H._updateRoutines=()=>{let e=H._updRoutines.length;if(!(e<=0))for(let t=0;t<e;t++)H._updRoutines[t]()},H._updateTSets=()=>{const e=H._tsets.length;if(!(e<=0)){H.Nav._camera.updateMatrixWorld();for(let t=0;t<e;t++)H._tsets[t].update()}},H._updateAniMixers=()=>{let e=H._aniMixers.length;if(!(e<1))for(let t=0;t<e;t++)H._aniMixers[t].update(H._dt)},H._updateScreenMove=e=>{e.preventDefault&&e.preventDefault(),H._bCenteredQuery||(H._screenPointerCoords.x=e.clientX/window.innerWidth*2-1,H._screenPointerCoords.y=-e.clientY/window.innerHeight*2+1)},H.toggleCenteredQuery=e=>{H._bCenteredQuery=e,e&&(H._screenPointerCoords.x=0,H._screenPointerCoords.y=0)},H._registerRCS=()=>{H._rcRR=0,H._rcHandlers=[],H._rcHandlers.push(H._handleQueryScene),H._rcHandlers.push(H._handleQuerySemantics),H._rcHandlers.push(H._handleQueryUI)},H._handleQueries=()=>{if(H._bPauseQuery)return;if(H.Nav._bInteracting)return;if(H._numReqLoad>0)return;if(H.Nav.isTransitioning())return;if(H._handleQueryUI(),H._bqScene&&H._handleQueryScene(),H._bqSem&&H._handleQuerySemantics(),H.Nav.locomotionValidator(),void 0===H._tgiDur)return;if(void 0===H._tHover)return;const e=H._clock.elapsedTime-H._tHover;e>=H._tgiDur?(H._stdActivation(),H._tHover=void 0,H._tgiPer=void 0):H._tgiPer=e/H._tgiDur},H._handleQueryScene=()=>{if(H.XR.isPresenting()?H.XR.setupQueryRay(H._rcScene):H._rcScene.setFromCamera(H._screenPointerCoords,H.Nav._camera),H._hitsScene=[],H._rcScene.intersectObjects(H._mainRoot.children,!0,H._hitsScene),H._hitsScene.length<=0)return void(H._queryDataScene=void 0);const e=H._hitsScene[0];H._queryDataScene={},H._queryDataScene.p=e.point,H._queryDataScene.d=e.distance,H._queryDataScene.o=e.object,H._bQueryNormals&&null!==e.face&&void 0!==e.face.normal&&(H._queryDataScene.matrixWorld=(new THREE.Matrix3).getNormalMatrix(e.object.matrixWorld),H._queryDataScene.n=e.face.normal.clone().applyMatrix3(H._queryDataScene.matrixWorld).normalize())},H.getSceneQueriedPoint=()=>{if(void 0!==H._queryDataScene)return H._queryDataScene.p},H.getSceneQueriedDistance=()=>{if(void 0!==H._queryDataScene)return H._queryDataScene.d},H.getSceneQueriedNormal=()=>{if(void 0!==H._queryDataScene)return H._queryDataScene.n},H._handleQuerySemantics=()=>{if(H.XR.isPresenting()?H.XR.setupQueryRay(H._rcSemantics):H._rcSemantics.setFromCamera(H._screenPointerCoords,H.Nav._camera),H._hitsSem=[],H._rcSemantics.intersectObjects(H._mainRoot.children,!0,H._hitsSem),H._hitsSem.length<=0){if(H._queryDataSem=void 0,H._hoveredSemNode){H.fireEvent("SemanticNodeLeave",H._hoveredSemNode);let e=H.getSemanticNode(H._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return H._hoveredSemNode=void 0,void(H._tHover=void 0)}const e=H._hitsSem[0];if(H._bQuerySemOcclusion&&H._queryDataScene&&H._queryDataScene.d<e.distance){if(H._queryDataSem=void 0,H._hoveredSemNode){H.fireEvent("SemanticNodeLeave",H._hoveredSemNode);let e=H.getSemanticNode(H._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return H._hoveredSemNode=void 0,void(H._tHover=void 0)}H._queryDataSem={},H._queryDataSem.p=e.point,H._queryDataSem.d=e.distance,H._queryDataSem.o=e.object,H._queryDataSem.list=[];const t=H._queryDataSem.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==H.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&H._hoveredSemNode!==i){if(H._hoveredSemNode){H.fireEvent("SemanticNodeLeave",H._hoveredSemNode);let e=H.getSemanticNode(H._hoveredSemNode);e&&e.onLeave&&e.onLeave(),H._tHover=void 0}H._hoveredSemNode=i,H.fireEvent("SemanticNodeHover",i);let e=H.getSemanticNode(i);e&&e.onHover&&e.onHover(),H._tHover=H._clock.elapsedTime}},H._handleQueryUI=()=>{if(H.XR.isPresenting()?H.XR.setupQueryRay(H._rcUI):H._rcUI.setFromCamera(H._screenPointerCoords,H.Nav._camera),H._hitsUI=[],H._rcUI.intersectObjects(H._mainRoot.children,!0,H._hitsUI),H._hitsUI.length<=0){if(H._queryDataUI=void 0,H._hoveredUI){H.fireEvent("UINodeLeave",H._hoveredUI);const e=H.getUINode(H._hoveredUI);e&&e.onLeave&&e.onLeave()}return H._hoveredUI=void 0,void(H._tHover=void 0)}const e=H._hitsUI[0];if(H._queryDataScene&&H._queryDataScene.d<e.distance){if(H._queryDataUI=void 0,H._hoveredUI){H.fireEvent("UINodeLeave",H._hoveredUI);const e=H.getUINode(H._hoveredUI);e&&e.onLeave&&e.onLeave()}return H._hoveredUI=void 0,void(H._tHover=void 0)}H._queryDataUI={},H._queryDataUI.p=e.point,H._queryDataUI.d=e.distance,H._queryDataUI.o=e.object,H._queryDataUI.list=[];const t=H._queryDataUI.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==H.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&H._hoveredUI!==i){if(H._hoveredUI){H.fireEvent("UINodeLeave",H._hoveredUI);const e=H.getUINode(H._hoveredUI);e&&e.onLeave&&e.onLeave(),H._tHover=void 0}H._hoveredUI=i,H.fireEvent("UINodeHover",i);const e=H.getUINode(i);e&&e.onHover&&e.onHover(),H._tHover=H._clock.elapsedTime}},H.setSketchFabAPIToken=e=>{H._extAPItokens.sketchfab=e}})();